---
title: "Car Jacking MPLS - Tract"
author: "Ryan Larson"
date: "`r Sys.Date()`"
output: pdf_document
---



```{r setup, include=FALSE, message=F}
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(tidycensus)
library(sf)
library(purrr)
library(ggmap)
library(stargazer)
library(stringr)
library(lubridate)
library(ISOweek)
library(zoo)

#TO DO!
#old
#descriptive paper: over-time; tracts over time
#build dataset at the incident level; spatially join tract information 
#collective efficacy: any purchase on this? 
#time-varying indicators of pandemic, school closures, institution closures, social safety net, pandemic checks
#analysis of discrepancies between incidents and charges
#compare to homicides
#media stuff - coverage is responsible to rates in which places


# Research Q: what tracts experienced what kind of increase?
#is the rate/count above a certain threshold - any vs. none
#DV: none-to-any; multinomial?

#Dv: media attention - following raw change vs. different types of change in certain places

#t-tests of variables between strib coverage and no coverage
#build # media mentions outcome variables
#time-series weekly model predicting media mentions, counts in advantaged vs. disadvantaged places
  #multinomial predictors (0-1, 1-few, few-many?)
#(months/quarters for the plot) 

#chow tests
  #iterative?
#splm models
#model robustness (count models etc.)


set.seed(7188)
google_key <- readRDS("C:/Users/rlarson21/Documents/R/Rworkingdirectory/google_api_key.rds")
register_google(key = google_key)
census_api_key("ecda17575f4d914b502c70f2bae7a5f3d253792d")
```

# Spatial Data

```{r, message=FALSE, warning=FALSE}
#MN tracts
tracts <- get_acs(geography = "tract", 
                  state = "MN",
                variables = "B01001_001E",
                output = "wide",
                survey = "acs5",
                year = 2020,
                geometry = T)

#Minneapolis Shapefile
mpls <- st_read("Data/mpls_city-shp/16cdbbfa-ad10-493c-afaf-52b61f2e76e42020329-1-180h9ap.whbo.shp") %>%
   st_transform(st_crs(tracts))

mpls_tract <- tracts %>%
  st_filter(mpls, .predicate = st_intersects) %>%
  mutate(GEOID = as.numeric(GEOID),
         tract_area = as.numeric(st_area(.)),
         tract_area_sqkm = tract_area*.000001, 
         tract_area_sqmi = tract_area_sqkm*.386102,
         intersection_area = as.numeric(st_area(st_intersection(., mpls))),
         perc_intersection = intersection_area/tract_area*100) %>%
  filter(perc_intersection >= 2) %>%
  select(-"B01001_001M")
```

# ACS Covariates

```{r}
acs_17 <- get_acs(
  geography = "tract",
  variables = c("B01001_001E"),
  year = 2017,
  state = "MN",
  county = "Hennepin",
  geometry = TRUE) %>% 
  select(estimate)

acs_18 <- get_acs(
  geography = "tract",
  variables = c("B01001_001E"),
  year = 2018,
  state = "MN",
  county = "Hennepin",
  geometry = TRUE
) %>%
select(estimate)

acs_19 <- get_acs(
  geography = "tract",
  variables = c("B01001_001E"),
  year = 2019,
  state = "MN",
  county = "Hennepin",
  geometry = TRUE
) %>%
select(estimate)


acs_20 <- get_acs(
  geography = "tract",
  variables = c("B01001_001E"),
  year = 2020,
  state = "MN",
  county = "Hennepin",
  geometry = TRUE
 )

library(tigris)

hennepin_blocks <- blocks(
  "MN",
  "Hennepin",
  year = 2020
)

#2017 ACS interpolation
acs_1720 <- interpolate_pw(
  from = acs_17,
  to = acs_20,
  to_id = "GEOID",
  weights = hennepin_blocks,
  weight_column = "POP20",
  crs = 26993,
  extensive = TRUE) %>%
  mutate(year = 2017) 

#2018 ACS interpolation
acs_1820 <- interpolate_pw(
  from = acs_18,
  to = acs_20,
  to_id = "GEOID",
  weights = hennepin_blocks,
  weight_column = "POP20",
  crs = 26993,
  extensive = TRUE) %>%
  mutate(year = 2018)


#2019 ACS interpolation
acs_1920 <- interpolate_pw(
  from = acs_19,
  to = acs_20,
  to_id = "GEOID",
  weights = hennepin_blocks,
  weight_column = "POP20",
  crs = 26993,
  extensive = TRUE) %>%
  mutate(year = 2019)


pop_denoms <- acs_20 %>%
  st_transform(crs = 26993) %>%
  mutate(year = 2020) %>%
  select(-moe, -variable, -NAME) %>%
  rbind(acs_1720, acs_1820, acs_1920) %>%
  filter(GEOID %in% mpls_tract$GEOID)

#2021+2022: LOCF
pop_denom_21 <- pop_denoms %>%
  filter(year==2020) %>%
  select(GEOID, year, estimate) %>%
  mutate(year = 2021) 

pop_denom_22 <- pop_denoms %>%
  filter(year==2020) %>%
  select(GEOID, year, estimate) %>%
  mutate(year = 2022) 

pop_denom_locf <- pop_denoms %>% 
  rbind(pop_denom_21, pop_denom_22) %>%
  rename(total_pop = estimate) %>%
  mutate(GEOID = as.numeric(GEOID)) %>%
  st_drop_geometry()

#ACS 2020 L-2 covariates
acs_2020 <- get_acs(geography = "tract", 
            state = "MN",
               variables = c("B01001_001E", "B03002_003E", "B03002_004E", "B03002_005E",
                             "B03002_006E", "B03002_007E", "B03002_008E", "B03002_009E",
                             "B03002_010E", "B03002_011E", "B03002_012E", "B23025_002E",
                             "B23025_005E", "B17001_002E", "B19057_002E", "B11003_015E", 
                             "B06009_002E", "B06009_005E", "C24010_001E", "C24010_003E",
                             "C24010_039E", "B11001_003E", "B01001_002E", "B05001_006E",
                             "B01001_003E", "B01001_004E", "B01001_005E", "B01001_006E",
                             "B01001_007E", "B01001_008E", "B01001_009E", "B01001_010E",
                             "B01001_011E", "B01001_012E", "B01001_013E", "B01001_014E",
                             "B01001_015E", "B01001_016E", "B01001_017E", "B01001_018E",
                             "B01001_019E", "B01001_020E", "B01001_021E", "B01001_022E",
                             "B01001_023E", "B01001_024E", "B01001_025E", "B01001_027E",
                             "B01001_028E", "B01001_029E", "B01001_030E", "B01001_031E",
                             "B01001_032E", "B01001_033E", "B01001_034E", "B01001_035E",
                             "B01001_036E", "B01001_037E", "B01001_038E", "B01001_039E",
                             "B01001_040E", "B01001_041E", "B01001_042E", "B01001_043E",
                             "B01001_044E", "B01001_045E", "B01001_046E", "B01001_047E", 
                             "B01001_048E", "B01001_049E", "B07001_017E", "B25003_002E",
                             "B05002_013E", "B19013_001E"),
               output = "wide",
               survey = "acs5",
               year = 2020) %>%
  select(-ends_with("M", ignore.case = F)) %>%
  rename(total_pop = B01001_001E, white_pop = B03002_003E, black_pop = B03002_004E,
         na_pop = B03002_005E, asian_pop = B03002_006E, hpi_pop = B03002_007E,
         other_pop = B03002_008E, biracial_pop = B03002_009E, biracial_other_pop = B03002_010E,
         biracial_three_pop = B03002_011E, hisp_pop = B03002_012E, total_ilf = B23025_002E,
         unemp = B23025_005E, povlevel = B17001_002E, pub_assist = B19057_002E,
         female_hh = B11003_015E, no_hs_dip = B06009_002E, bach_degree = B06009_005E,
         total_employed = C24010_001E, employed_mbsa_male = C24010_003E,
         employed_mbsa_female = C24010_039E, mar_fam = B11001_003E, male = B01001_002E,
         noncitizen = B05001_006E,
        age_m_5_under = B01001_003E, age_m_5_9 = B01001_004E, age_m_10_14 = B01001_005E, 
        age_m_15_17 = B01001_006E, age_m_18_19 = B01001_007E, age_m_20 = B01001_008E,
        age_m_21 = B01001_009E, age_m_22_24 = B01001_010E, age_m_25_29 = B01001_011E, 
        age_m_30_34 = B01001_012E, age_m_35_39 = B01001_013E, age_m_40_44 = B01001_014E,
        age_m_45_49 = B01001_015E, age_m_50_54 = B01001_016E, age_m_55_59 = B01001_017E, 
        age_m_60_61 = B01001_018E, age_m_62_64 = B01001_019E, age_m_65_66 = B01001_020E,
        age_m_67_69 = B01001_021E, age_m_70_74 = B01001_022E, age_m_75_79 = B01001_023E, 
        age_m_80_84 = B01001_024E, age_m_85_plus = B01001_025E, age_f_5_under = B01001_027E,
        age_f_5_9 = B01001_028E, age_f_10_14 = B01001_029E, age_f_15_17 = B01001_030E, 
        age_f_18_19 = B01001_031E, age_f_20 = B01001_032E, age_f_21 = B01001_033E,
        age_f_22_24 = B01001_034E, age_f_25_29 = B01001_035E, age_f_30_34 = B01001_036E, 
        age_f_35_39 = B01001_037E, age_f_40_44 = B01001_038E, age_f_45_49 = B01001_039E,
        age_f_50_54 = B01001_040E, age_f_55_59 = B01001_041E, age_f_60_61 = B01001_042E, 
        age_f_62_64 = B01001_043E, age_f_65_66 = B01001_044E, age_f_67_69 = B01001_045E, 
        age_f_70_74 = B01001_046E, age_f_75_79 = B01001_047E, age_f_80_84 = B01001_048E, 
        age_f_85_plus = B01001_049E, res_mob = B07001_017E, 
        own_hh = B25003_002E, foreign = B05002_013E,
        med_hh_inc = B19013_001E) %>%
  mutate(white_prop = white_pop/total_pop,
         black_prop = black_pop/total_pop,
         na_prop = na_pop/total_pop,
         asian_prop = asian_pop/total_pop,
         hpi_prop = hpi_pop/total_pop,
         other_prop = other_pop/total_pop,
         biracial_prop = (biracial_pop+biracial_other_pop+biracial_three_pop)/total_pop,
         hisp_prop = hisp_pop/total_pop,
         white_perc = 100*white_pop/total_pop,
         black_perc = 100*black_pop/total_pop,
         na_perc = 100*na_pop/total_pop,
         asian_perc = 100*asian_pop/total_pop,
         hpi_perc = 100*hpi_pop/total_pop,
         other_perc = 100*other_pop/total_pop,
         biracial_perc = 100*(biracial_pop+biracial_other_pop+biracial_three_pop)/total_pop,
         hisp_perc = 100*hisp_pop/total_pop,
         unemp_rate = 100*unemp/total_ilf, 
         pov_rate = 100*povlevel/total_pop,
         pub_assist_rate = 100*pub_assist/total_pop,
         female_hh_rate = 100*female_hh/total_pop,
         no_hs_dip_rate = 100*no_hs_dip/total_pop,
         bach_degree_rate = 100*bach_degree/total_pop,
         employed_mbsa = employed_mbsa_male+employed_mbsa_female,
         employed_mbsa_rate = 100*employed_mbsa/total_employed,
         mar_fam_rate = 100*mar_fam/total_pop, 
         male_rate = 100*male/total_pop,
         noncitizen_rate = 100*noncitizen/total_pop,
         race_eth_hetero  = 1-(white_prop^2+black_prop^2+na_prop^2+asian_prop^2+
                       hpi_prop^2+other_prop^2+other_prop^2+biracial_prop^2+hisp_prop^2),
         age_below_18_perc = 100*(age_m_5_under+age_f_5_under+age_m_5_9+
                                  age_f_5_9+age_m_10_14+age_f_10_14+age_m_15_17+
                                  age_f_15_17)/total_pop,
         age_19_29_perc = 100*(age_m_18_19+age_f_18_19+age_m_20+age_f_20+age_m_21+age_f_21+
                          age_m_22_24+age_f_22_24+age_m_25_29+age_f_25_29)/total_pop,
         age_30_49_perc = 100*(age_m_30_34+age_f_30_34+age_m_35_39+age_f_35_39+
                               age_m_40_44+age_f_40_44+age_m_45_49+age_f_45_49)/total_pop,
         age_50_69_perc = 100*(age_m_50_54+age_f_50_54+age_m_55_59+age_f_55_59+
                               age_m_60_61+age_f_60_61+age_m_62_64+age_f_62_64+
                               age_m_65_66+age_f_65_66+age_m_67_69+age_f_67_69)/total_pop,
         age_70_plus_perc = 100*(age_m_70_74+age_f_70_74+age_m_75_79+age_f_75_79+
                                 age_m_80_84+age_f_80_84+age_m_85_plus+age_f_85_plus)/total_pop,
         res_mob_rate = 100-100*res_mob/total_pop,
         own_hh_rate = 100*own_hh/total_pop,
         foreign_rate = 100*foreign/total_pop) 

# 2020 Census 18+ Denominator
dc2020 <- get_decennial(
  geography = "tract",
  variables = c("P3_001N"),
  year = 2020,
  state = "MN",
  county = "Hennepin",
  geometry = F) %>%
  mutate(GEOID = is.numeric(GEOID)) %>%
  rename(total_pop = value) %>%
  select(-GEOID)
```

# Open Minneapolis Carjacking Data

```{r, message=FALSE}
#open minneapolis crime data 2019-4/7 (date of download)
cj_spatial <- read_csv("Car Jacking/crime_data.csv")  %>%
  filter(Offense=="Carjacking - Subset of Robbery") %>% #filter carjackings
  mutate(date=ymd_hms(Occurred_Date),
         year=isoyear(date),
         week=isoweek(date)) %>%
  select(OBJECTID, year, week, Latitude, Longitude) %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = "NAD83", remove=F) %>%
  st_join(mpls_tract) %>% #spatial join neighborhoods
  st_drop_geometry() %>%
  filter(!is.na(GEOID)) %>%
  group_by(year, week, GEOID, .drop=F) %>%
  tally(name = "car_jack") %>%
  ungroup() %>%
  complete(year, week, GEOID=mpls_tract$GEOID, fill = list(car_jack = 0)) %>%
  filter(!(year==2022 & week >= 14) & #removing unobserved/redundant completions
           !(year==2021 & week==53) & #removing unobserved/redundant completions
           !(year==2020 & week < 36)) %>% #removing weeks before Sept. 2020, isoweek 36
  arrange(GEOID, year, week) %>%
  left_join(mpls_tract, by = "GEOID") %>%
  left_join(pop_denom_locf, by = c("GEOID", "year")) %>%
  mutate(car_jack_rate = car_jack/total_pop*1000) %>%
  st_as_sf()
```


# MPLS Carjackings by Week

```{r}
#aggregate to week over tracts
cj_week <- cj_spatial %>%
  group_by(year, week) %>%
  summarize(car_jack = sum(car_jack, na.rm = T),
            total_pop = sum(total_pop, na.rm = T)) %>%
  mutate(begin_date = ISOweek2date(paste(year, paste0("W", sprintf("%02d", week)), 1,sep = "-")),
         end_date = begin_date+weeks(1)-days(1),
         car_jack_rate = car_jack/total_pop*1000) 
  
ggplot(cj_week)+
  geom_line(aes(x=begin_date, y=car_jack_rate))+ 
  scale_x_date(date_labels = "%b-%Y", 
               limits = c(min(cj_week$begin_date), max(cj_week$begin_date)))+
  labs(title = "Figure X: Weekly Minneapolis Carjackings, 8/31/2020-4/7/2022",
       subtitle = "openminneapolis Crime Data",
       x = "Week",
       y = "Weekly Carjacking Rate/ 1,000")+
  theme_minimal()+
    theme(axis.text.x=element_text(angle=45, hjust=1)) 

```


# MPLS ZCTA Carjackings Map

```{r}
#aggregate to neighborhood-year level
cj_tract_year <- cj_spatial %>%
  group_by(GEOID, year) %>%
  summarize(car_jack = sum(car_jack, na.rm = T),
            total_pop = sum(B01001_001E, na.rm = T),
            car_jack_rate = car_jack/total_pop*1000) 


ggplot() +
  geom_sf(data = cj_tract_year, aes(geometry = geometry, fill = car_jack_rate)) + 
  geom_sf(data = mpls, aes(geometry = geometry), color = "black", alpha = 0)+
  facet_wrap(~year)+
  scale_fill_distiller(palette = "Spectral")+
  labs(title = "Figure X: Minneapolis Carjacking Rates by Tract and Year", 
       subtitle = "openminneapolis Crime Data",
       fill = "Weekly Rate/ 1,000")+
  theme_void()
```



# Expanded MPLS Carjacking (Crime Incidents) Data

```{r}
cj_exp <- read_csv("Data/MPDdata_082422.csv") %>%
   mutate(date=mdy_hm(reporteddate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  select(CaseNumber, year, week, latitude, longitude) %>%
  distinct(CaseNumber, .keep_all = TRUE) %>%
  drop_na(latitude, longitude) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = "NAD83", remove=F) %>%
  st_join(mpls_tract) %>% #spatial join neighborhoods
  st_drop_geometry() %>%
  drop_na(GEOID) %>%
  group_by(year, week, GEOID, .drop=F) %>%
  tally(name = "car_jack") %>%
  ungroup() %>%
  complete(year, week, GEOID=mpls_tract$GEOID, fill = list(car_jack = 0)) %>%
  filter(!(year==2021 & week==53)) %>% 
  arrange(GEOID, year, week) %>%
  left_join(mpls_tract, by = "GEOID") %>%
  left_join(dc2020, by = c("NAME")) %>%
  mutate(car_jack_rate = car_jack/total_pop*1000) %>%
  st_as_sf()
```

# MPLS Carjackings by Week - MPD Extended Data

```{r}
#aggregate to week over tracts
cj_exp_week <- cj_exp %>%
  group_by(year, week) %>%
  summarize(car_jack = sum(car_jack, na.rm = T),
            total_pop = sum(total_pop, na.rm = T)) %>%
  mutate(begin_date = ISOweek2date(paste(year, paste0("W", sprintf("%02d", week)), 1,sep = "-")),
         end_date = begin_date+weeks(1)-days(1),
         car_jack_rate = car_jack/total_pop*1000, 
         pre_post_floyd = ifelse(end_date <= as.Date("2020-05-25"), 0, 1)) %>%
  filter(end_date <= as.Date("2022-08-20")) %>% 
  mutate(csma = forecast::ma(car_jack_rate, order=5, centre=TRUE),
         tsma = TTR::SMA(car_jack_rate, n=5))

pre_mean <- mean(cj_exp_week$car_jack_rate[cj_exp_week$pre_post_floyd==0], na.rm = T)
post_mean <- mean(cj_exp_week$car_jack_rate[cj_exp_week$pre_post_floyd==1], na.rm = T)

c(pre_mean, post_mean)
post_mean/pre_mean


ggplot(cj_exp_week)+
  geom_line(aes(x=begin_date, y=car_jack_rate))+ 
  scale_x_date(date_labels = "%b-%Y", date_breaks = "15 weeks",
               limits = c(min(cj_exp_week$begin_date), max(cj_exp_week$begin_date)))+
  geom_vline(xintercept=cj_exp_week$begin_date[cj_exp_week$year==2020 & 
                                                 cj_exp_week$week==isoweek(date("2020-05-25"))], 
              linetype="dotted", color="red", size=1)+
   geom_label(aes(x=cj_exp_week$begin_date[cj_exp_week$year==2020 &
                                             cj_exp_week$week==isoweek(date("2020-05-25"))],
                 y=0.065), 
             label = "George Floyd", show.legend = FALSE)+
  labs(title = "Figure 1: Weekly Minneapolis Carjackings, 1/1/2017-8/20/2022",
       x = "Week",
       y = "Weekly Carjacking Rate/ 1,000",
       color = NULL)+
  geom_line(aes(x=begin_date, y=csma, color = "CSMA(5)"))+
  theme_minimal()+
    theme(axis.text.x=element_text(angle=45, hjust=1))  +
  theme(legend.key.size = unit(0.8, "cm"),legend.position = "bottom")

ggsave(filename = "Car Jacking/Figures for PAA/fig1.png", bg="white", width = 10, height = 8)
```


# MPLS ZCTA Carjackings Map - MPD Extended Data

```{r}
#aggregate to neighborhood-year level
cj_exp_tract_year <- cj_exp %>%
  group_by(GEOID, year) %>%
  summarize(car_jack = sum(car_jack, na.rm = T),
            total_pop = sum(B01001_001E, na.rm = T),
            car_jack_rate = car_jack/total_pop*1000) %>%
  mutate(GEOID = as.character(GEOID))


ggplot() +
  geom_sf(data = cj_exp_tract_year, aes(geometry = geometry, fill = car_jack_rate)) + 
  geom_sf(data = mpls, aes(geometry = geometry), color = "black", alpha = 0)+
  facet_grid(~year)+
  scale_fill_distiller(palette = "Spectral")+
  labs(title = "Figure 2: Minneapolis Carjacking Rates by Tract and Year", 
       fill = "Weekly Rate/ 1,000")+
  theme_void()+
  theme(legend.key.size = unit(0.8, "cm"),legend.position = "bottom")

ggsave(filename = "Car Jacking/Figures for PAA/fig2.png", bg="white", width = 10, height = 8)
```

#  MPLS Murder (Crime Incidents) Data

```{r}
#pre-pims
mpd_2016 <- read_csv("Data/Police_Incidents_2016.csv") 
mpd_2017 <- read_csv("Data/Police_Incidents_2017.csv") 
mpd_2018a <- read_csv("Data/Police_Incidents_2018.csv")

#pims
mpd_2018b <- read_csv("Data/Police_Incidents_2018_PIMS.csv") 
mpd_2019 <- read_csv("Data/Police_Incidents_2019.csv") 
mpd_2020 <- read_csv("Data/Police_Incidents_2020.csv") 
mpd_2021 <- read_csv("Data/Police_Incidents_2021.csv")
mpd_2022 <- read_csv("Data/Police_Incidents_2022.csv")


pre_pims_base <- mpd_2016 %>%
  rbind(mpd_2017) %>%
  rbind(mpd_2018a) %>%
  rename(reportedDate = ReportedDate,
         centerLong = Long,
         centerLat = Lat) %>%
  select(FID, centerLong, centerLat, Offense, reportedDate) %>%
  rename(OBJECTID = FID, 
         X = centerLong, 
         Y = centerLat, 
         offense = Offense)

post_pims_base <- mpd_2018b %>%
  rbind(mpd_2019) %>%
  rbind(mpd_2020) %>%
  rbind(mpd_2021) %>%
  rbind(mpd_2022) %>%
  select(OBJECTID, X, Y, offense, reportedDate)

mpd <- pre_pims_base %>%
  rbind(post_pims_base) 

#aggregate homicides to tract-week
homicide <- mpd %>%
  mutate(date=ymd_hms(reportedDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  filter(offense=="MURDR" & year!=2016 & year!=2015) %>% #filter homicides
  select(OBJECTID, year, week, Y, X) %>%
  st_as_sf(coords = c("X", "Y"), crs = "NAD83", remove=F) %>%
  st_join(mpls_tract) %>% #spatial join neighborhoods
  st_drop_geometry() %>%
  filter(!is.na(GEOID)) %>%
  group_by(year, week, GEOID, .drop=F) %>%
  tally(name = "homicide") %>%
  ungroup() %>%
  complete(year, week, GEOID=mpls_tract$GEOID, fill = list(homicide = 0)) %>%
  filter(!(year==2021 & week==53)) %>% 
  arrange(GEOID, year, week) %>%
  left_join(mpls_tract, by = "GEOID") %>%
  left_join(dc2020, by = c("NAME")) %>%
  mutate(homicide_rate = homicide/total_pop*1000) %>%
  st_as_sf()
```

# MPLS Murder by Week 

```{r}
#aggregate to week over tracts
homicide_week <- homicide %>%
  group_by(year, week) %>%
  summarize(homicide = sum(homicide, na.rm = T),
            total_pop = sum(total_pop, na.rm = T)) %>%
  mutate(begin_date = ISOweek2date(paste(year, paste0("W", sprintf("%02d", week)), 1,sep = "-")),
         end_date = begin_date+weeks(1)-days(1),
         homicide_rate = homicide/total_pop*1000,
         pre_post_floyd = ifelse(end_date <= as.Date("2020-05-25"), 0, 1)) %>%
  filter(end_date <= as.Date("2022-08-20")) %>% 
  mutate(csma = forecast::ma(homicide_rate, order=5,centre=TRUE),
         tsma = TTR::SMA(homicide_rate, n=5))

pre_mean <- mean(homicide_week$homicide_rate[homicide_week$pre_post_floyd==0], na.rm = T)
post_mean <- mean(homicide_week$homicide_rate[homicide_week$pre_post_floyd==1], na.rm = T)

c(pre_mean, post_mean)
post_mean/pre_mean

  
ggplot(homicide_week)+
  geom_line(aes(x=begin_date, y=homicide_rate))+ 
 scale_x_date(date_labels = "%b-%Y", date_breaks = "15 weeks",
               limits = c(min(homicide_week$begin_date), max(homicide_week$begin_date)))+
     labs(title = "Figure 3: Weekly Minneapolis Homicide, 1/1/2017-8/20/2022",
       x = "Week",
       y = "Weekly Homicide Rate/ 1,000",
       color = NULL)+
  geom_vline(xintercept=homicide_week$begin_date[homicide_week$year==2020 & 
                                                 homicide_week$week==isoweek(date("2020-05-25"))], 
              linetype="dotted", color="red", size=1)+
   geom_label(aes(x=homicide_week$begin_date[homicide_week$year==2020 &
                                             homicide_week$week==isoweek(date("2020-05-25"))],
                 y=0.015), 
             label = "George Floyd", show.legend = FALSE)+
  theme_minimal()+
  geom_line(aes(x=begin_date, y=csma, color = "CSMA(5)"))+
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  theme(legend.key.size = unit(0.8, "cm"),legend.position = "bottom")

ggsave(filename = "Car Jacking/Figures for PAA/fig3.png", bg="white", width = 10, height = 8)
```

# MPLS ZCTA Murder Map - MPD Extended Data

```{r}
#aggregate to neighborhood-year level
homicide_tract_year <- homicide %>%
  group_by(GEOID, year) %>%
  summarize(homicide = sum(homicide, na.rm = T),
            total_pop = sum(B01001_001E, na.rm = T),
            homicide_rate = homicide/total_pop*1000) %>%
  mutate(GEOID = as.character(GEOID))


ggplot() +
  geom_sf(data = homicide_tract_year, aes(geometry = geometry, fill = homicide_rate)) + 
  geom_sf(data = mpls, aes(geometry = geometry), color = "black", alpha = 0)+
  facet_grid(~year)+
  scale_fill_distiller(palette = "Spectral")+
  labs(title = "Figure 4: Minneapolis Homicide Rates by Tract and Year", 
       fill = "Weekly Rate/ 1,000")+
  theme_void() +
  theme(legend.key.size = unit(0.8, "cm"),legend.position = "bottom")

ggsave(filename = "Car Jacking/Figures for PAA/fig4.png", bg="white", width = 10, height = 8)
```

# Dispersion of Change from 2017-2019 to 2020-2021

## Car Jacking

```{r}
crimedispersion <- function
(data1, unitID, time1, time2, method = "match") {

  # define variables to limit build warnings
  adjusted <- Ut1 <- Ut2 <- Rt1 <- Rt2 <- chg <- pct <- NULL

  # ERROR CHECKING. Has user passed a data frame?
  if (!is.data.frame(data1)) {
    stop("The input data specified is not a data.frame object. Please fix.")
  }

  # Build a local data.frame and populate with passed arguments
  source_rows <- nrow(data1)
  df1 <- data.frame(matrix(ncol = 3, nrow = source_rows))
  colnames(df1) <- c("unit", "time1", "time2")
  df1$unit <- data1[, unitID]
  df1$time1 <- data1[, time1]
  df1$time2 <- data1[, time2]
  if (method == "remove") {
    analysisMethod <- "remove"
  } else {
    analysisMethod <- "match"
  }


  # ERROR CHECKING. Did user pass numeric columns where needed?
  try (df1$time1 <- as.numeric(df1$time1), silent = TRUE)
  try (df1$time2 <- as.numeric(df1$time2), silent = TRUE)

  if (!class(df1$time1)[1] == "numeric") {
    stop("The time1 field is not a numeric object. Please fix.")
  }
  if (!class(df1$time2)[1] == "numeric") {
    stop("The time2 field is not a numeric object. Please fix.")
  }

  # MORE ERROR CHECKING:
  # What if the user has NA or missing data?
  # What if the crime problem is decreasing?
  # Fun tasks for later...


  # Set up parameters -------------------------------------------------------

  # Set up initial parameters
  count_Rt1 <- sum(df1$time1)
  count_Rt2 <- sum(df1$time2)
  chg_Rt1_Rt2 <- count_Rt2 - count_Rt1
  pct_Rt1_Rt2 <- (chg_Rt1_Rt2 / count_Rt1) *100

  # Add the field that has the volume of change, and order by it
  df1 <- df1 %>%
    mutate (diff = time2 - time1) %>%
    mutate (diffPct = 100*(diff/time1)) %>%
    arrange(desc(diff))

  # Grab some basic statistics here
  numPositive <- length(which(df1$diff > 0))
  numNeutral <- length(which(df1$diff == 0))
  numNegative <- length(which(df1$diff < 0))


  # Create the new data frame to hold the result
  df2 <- data.frame(matrix(ncol =8, nrow = 0))
  colnames(df2) <- c("unit", "adjusted", "Ut1", "Ut2", "Rt1", "Rt2", "chg", "pct")
  df2 <- df2 %>%
    mutate(unit = as.character(unit)) %>%
    mutate(adjusted = as.numeric(adjusted)) %>%
    mutate(Ut1 = as.numeric(Ut1)) %>%
    mutate(Ut2 = as.numeric(Ut2)) %>%
    mutate(Rt1 = as.numeric(Rt1)) %>%
    mutate(Rt2 = as.numeric(Rt2)) %>%
    mutate(chg = as.numeric(chg)) %>%
    mutate(pct = as.numeric(pct))

  # set up the initial row in the result data frame
  df2 <- df2 %>% add_row(unit = "[ ALL AREAS ]", adjusted = 0,
                         Ut1 = 0, Ut2 = 0,
                         Rt1 = count_Rt1, Rt2 = count_Rt2,
                         chg = chg_Rt1_Rt2, pct = pct_Rt1_Rt2)

  gain_from_row_removal <- row_to_remove <- NULL


  # Loop through each row of the data
  for (master_loop in 1:(source_rows)){

    df1 <- df1 %>%  # order the data frame
      arrange(desc(diff))

    if (analysisMethod == "match"){
      #### 'Zero change the row' approach
      count_Rt1_temp <- count_Rt1
      count_Rt2_temp <- count_Rt2 - df1$diff[master_loop]
      pct_Rt1_Rt2 <- ((count_Rt1_temp - count_Rt2_temp) / count_Rt1) *100
    }
    else { #analysisMethod == "remove"
      #### 'Remove entire row' approach, including remove t1 value
      count_Rt1_temp <- count_Rt1 - df1$time1[master_loop]
      count_Rt2_temp <- count_Rt2 - df1$time2[master_loop]
      pct_Rt1_Rt2 <- ((count_Rt1_temp - count_Rt2_temp) / count_Rt1) *100
    }

    row_to_remove <- 1  # Always row 1, but this is a legacy from
    # when I used a different approach...
    # Here, the row we are removing is
    # stored in row_to_remove

    if (analysisMethod == "remove"){
      #### Remove entire row approach
      #    This approach removes the impact of the area by subtracting
      #    both Rt1 and Rt2
      count_Rt1 <- count_Rt1 - df1$time1[row_to_remove]
      count_Rt2 <- count_Rt2 - df1$time2[row_to_remove]
      chg_Rt1_Rt2 <- count_Rt2 - count_Rt1
      pct_Rt1_Rt2 <- (chg_Rt1_Rt2 / count_Rt1) *100
      named_areas <- df1$unit[row_to_remove]
    }

    if (analysisMethod == "match"){
      #### Zero change the row approach, as if Rt2 == Rt1 in the row
      #    The best row to remove is has been exhaustively calculated
      #    Here, the row we are removing is stored in row_to_remove
      count_Rt1 <- count_Rt1
      count_Rt2 <- count_Rt2 - df1$diff[row_to_remove]
      chg_Rt1_Rt2 <- count_Rt2 - count_Rt1
      pct_Rt1_Rt2 <- (chg_Rt1_Rt2 / count_Rt1) *100
      named_areas <- df1$unit[row_to_remove]
    }

    # Add result to the output data frame
    df2 <- df2 %>% add_row(unit = named_areas, adjusted = master_loop,
                           Ut1 = df1$time1[row_to_remove], Ut2 = df1$time2[row_to_remove],
                           Rt1 = count_Rt1, Rt2 = count_Rt2,
                           chg = chg_Rt1_Rt2, pct = pct_Rt1_Rt2)

    # Adjust the row we just used in one of two ways:
    # 1. remove the actual row entirely
    if (analysisMethod == "remove"){
      df1 <-df1[-c(row_to_remove), ]
    }
    #2. adjust the Rt2 to match Rt1 resulting in a zero diff
    #   but show that diff as < lowest diff in the data set so that
    #   the program does not stall with too many zeros
    if (analysisMethod == "match"){
      df1$time2[row_to_remove] <- df1$time1[row_to_remove]
      df1$diff[row_to_remove] <- -999 # this should be changed to always less than
      # the lowest diff score in the data set
    }

  } # end master_loop


  # Calculate ODI and NCDI indices -----------------------------------------
  NumContributed <- length(which(df2$chg > 0))
  ODI <- NumContributed / source_rows
  NCDI <- (numPositive - NumContributed) / source_rows
  ODI.text <- paste("O.D.I. = ", format(ODI, digits = 3), "after \nadjusting",
                    NumContributed, "of the", source_rows, "units")

  # Tidy up names for data frame --------------------------------------------

  df2 <- df2 %>%
    rename(unit_t1 = Ut1, unit_t2 = Ut2, region_t1 = Rt1, region_t2 = Rt2)

  # Plot --------------------------------------------------------------------

  df3 <- df2
  plot.adjustment <- ""
  if (nrow(df3) > 151)  {
    df3 <- df3[1:151, ]
    plot.adjustment <- "Plot only shows first\n100 areas adjusted"
  }


  p <- ggplot(df3, aes(x=reorder(unit, adjusted), y=pct, group = 1)) +
    geom_line(color="#3277a8") +
    geom_point(shape=21, color="white", fill="#3277a8", size=2) +
    geom_hline(color="grey", yintercept=0) +
    labs(title="Dispersion of crime change",
         x ="Area adjusted", y = "Remaining crime change for region") +
    annotate(
      geom = "curve", x = NumContributed+4, y = 1.5,
      xend = NumContributed+1, yend = 0.2,
      curvature = .2, arrow = arrow(length = unit(2, "mm"))
    ) +
    annotate(geom = "text", x = NumContributed+4.1, y = 1.5,
             label = ODI.text, hjust = "left") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +

    annotate(geom = "text", x = 2, y = df2$pct[1],
             label = paste0(format(df2$pct[1], digits = 3),"% overall"), hjust = "left") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

  if (plot.adjustment != "") {
    p <- p +
      annotate(geom = "text", x = 100, y = df3$pct[1]-1, label = plot.adjustment, hjust = "right")
  }

  p


  # Create return list ------------------------------------------------------

  output <- list(df2, p, NumContributed, ODI, NCDI)
  return(output)
}


prepost_cj <- cj_exp %>%
   mutate(begin_date = ISOweek2date(paste(year, paste0("W", sprintf("%02d", week)), 1,sep = "-")),
         end_date = begin_date+weeks(1)-days(1),
         pre_post_floyd = ifelse(end_date <= as.Date("2020-05-25"), 0, 1)) %>%
  filter(end_date <= as.Date("2022-08-20")) %>%
  group_by(GEOID, pre_post_floyd) %>%
  summarize(car_jack = sum(car_jack, na.rm = T),
            total_pop = sum(total_pop, na.rm = T)) %>%
  mutate(car_jack_rate = car_jack/total_pop*1000) %>%
  select(GEOID, pre_post_floyd, car_jack, car_jack_rate) %>% 
  st_drop_geometry() %>%
  pivot_wider(names_from = pre_post_floyd, values_from = c(car_jack, car_jack_rate)) %>%
  mutate(GEOID = as.character(GEOID)) 

output <- crimedispersion(as.data.frame(prepost_cj), 'GEOID', 'car_jack_rate_0', 'car_jack_rate_1')

ouput_data <- output[[1]]
n_remove <- output[[3]]
odi <- output[[4]] #ratio of n removed to n overall
ncdi <- output[[5]] #ratio of areas not contributing to overall increase but still increase to overall n

output[[2]]

ggsave(filename = "Car Jacking/Figures for PAA/fig5.png", bg="white", width = 10, height = 8)
```

## Homicide

```{r}
prepost_hom <- homicide %>%
 mutate(begin_date = ISOweek2date(paste(year, paste0("W", sprintf("%02d", week)), 1,sep = "-")),
         end_date = begin_date+weeks(1)-days(1),
         pre_post_floyd = ifelse(end_date <= as.Date("2020-05-25"), 0, 1)) %>%
  group_by(GEOID, pre_post_floyd) %>%
  summarize(homicide = sum(homicide, na.rm = T),
            total_pop = sum(total_pop, na.rm = T)) %>%
  mutate(homicide_rate = homicide/total_pop*1000) %>%
  st_drop_geometry() %>%
  select(GEOID, pre_post_floyd, homicide, homicide_rate) %>% 
  pivot_wider(names_from = pre_post_floyd, values_from = c(homicide, homicide_rate)) %>%
  mutate(GEOID = as.character(GEOID)) 

output_homicide <- crimedispersion(as.data.frame(prepost_hom), 'GEOID', 'homicide_0', 'homicide_1')

ouput_data <- output_homicide[[1]]
n_remove <- output_homicide[[3]]
odi <- output_homicide[[4]] #ratio of n removed to n overall
ncdi <- output_homicide[[5]] #ratio of areas not contributing to overall increase but still increase to overall n

output_homicide[[2]]
ggsave(filename = "Car Jacking/Figures for PAA/fig6.png", bg="white", width = 10, height = 8)

```

# Spatial Correlation *Change* in Carjackings and Homicide

## Carjacking

```{r}
library(sfdep)

cj_delta <- prepost_cj %>%
  mutate(delta = car_jack_rate_1-car_jack_rate_0,
         GEOID = as.numeric(GEOID)) %>%
  left_join(mpls_tract, by = "GEOID") %>%
  st_as_sf()

nb <- st_contiguity(cj_delta, queen=TRUE)
wt <-  st_weights(nb, style = "W")

global_moran_test(
  cj_delta$delta,
  nb,
  wt,
  alternative = "greater",
  randomization = TRUE)

#LISA
cj_lisa <-  local_moran(cj_delta$delta,
                       nb = nb,
                       wt = wt, 
                       nsim = 1000,
                       iseed = set.seed(7188)) %>%
  mutate(mean_p = ifelse(p_ii_sim <= 0.05, as.character(pysal), "Non Sig."),
         mean_p = factor(mean_p, levels = c("High-High", "High-Low", "Low-High", 
                                            "Low-Low", "Non Sig.")))

cj_delta %>% 
  cbind(cj_lisa) %>%
  ggplot(aes(fill = mean_p)) +
  geom_sf() +
  geom_sf(lwd = 0.2, color = "black") +
  theme_void() +
  scale_fill_manual(values = c("red", "yellow", "green", "blue","white"), drop = FALSE)+
  labs(title = "Figure 7: LISA Plot for Carjacking Change Pre/Post Police Murder",
       fill = "Cluster Type",
       caption = "Clusters significant at p < .05 with 1,000 simulations.")

ggsave(filename = "Car Jacking/Figures for PAA/fig7.png", bg="white", width = 10, height = 8)
```

## Homicide

```{r}
hom_delta <- prepost_hom %>%
  mutate(delta = homicide_1-homicide_0,
           GEOID = as.numeric(GEOID)) %>%
  left_join(mpls_tract, by = "GEOID") %>%
  st_sf()


nb <- st_contiguity(hom_delta, queen=TRUE)
wt <-  st_weights(nb, style = "W")

global_moran_test(
  hom_delta$delta,
  nb,
  wt,
  alternative = "greater",
  randomization = TRUE)

#LISA
hom_lisa <-  local_moran(hom_delta$delta,
                       nb = nb,
                       wt = wt, 
                       nsim = 1000,
                       iseed = set.seed(7188)) %>%
  mutate(mean_p = ifelse(p_ii_sim <= 0.05, as.character(pysal), "Non Sig."))

hom_delta %>% 
  cbind(hom_lisa) %>%
  ggplot(aes(fill = mean_p)) +
  geom_sf() +
  geom_sf(lwd = 0.2, color = "black") +
  theme_void() +
  scale_fill_manual(values = c("red", "yellow", "green","blue", "white"))+
  labs(title = "Figure 8: LISA Plot for Homicide Change Pre/Post Police Murder",
       fill = "Cluster Type",
       caption = "Clusters significant at p < .05 with 1,000 simulations.")

ggsave(filename = "Car Jacking/Figures for PAA/fig8.png", bg="white", width = 10, height = 8)
```


# RE CJ Models

```{r, message=F}
cj_exp_year_acs <- cj_exp_tract_year %>%
  left_join(acs_2020, by = c("GEOID")) %>%
  ungroup() %>%
  mutate(yearzero = year-2017,
         pov_rate_center = pov_rate-mean(pov_rate, na.rm = T),
         white_perc_center = scale(white_perc, center = T, scale = F),
         black_perc_center = scale(black_perc, center = T, scale = F),
         anyjack = ifelse(car_jack==0, 0, 1)) %>%
  drop_na()

cj_exp_prepost <- cj_exp %>% 
  mutate(begin_date = ISOweek2date(paste(year, paste0("W", sprintf("%02d", week)), 1,sep = "-")),
         end_date = begin_date+weeks(1)-days(1),
         post_floyd = as.numeric(begin_date >= as.Date("2020-05-25")),
         post_floyd_3 = as.numeric(begin_date >= as.Date("2020-05-25")+months(3)),
        # stay_at_home = as.numeric(begin_date >= as.Date("2020-03-28") &                                                                                     begin_date <= as.Date("2020-05-28")),
         #state_of_emerg = as.numeric(begin_date >= as.Date("2020-03-13")),
         period = factor(case_when(
           post_floyd==0 & post_floyd_3==0 ~ "Pre-Killing",
           post_floyd>=1 & post_floyd_3==0 ~ "0-3 Months Post-Killing",
           post_floyd>=1 & post_floyd_3>=1 ~ "3+ Months Post-Killing"),
           levels = c("Pre-Killing", "0-3 Months Post-Killing", "3+ Months Post-Killing")),
        GEOID = as.character(GEOID),
        anyjack = ifelse(car_jack==0, 0, 1),
        t = 1:length(car_jack_rate)) %>%
  left_join(acs_2020, by = c("GEOID")) %>%
  drop_na()

library(lme4)
library(lmerTest)


library(lavaan)

cd_model_1  <- ' cd =~ unemp_rate + pov_rate +  female_hh_rate + no_hs_dip_rate + black_perc 
                  black_perc ~~ unemp_rate'  

cfa_cd <- cfa(cd_model_1, data = cj_exp_prepost, std.lv = T)
modificationindices(cfa_cd)
summary(cfa_cd, fit.measures=TRUE, standardized = T)
cd_predict <- as.vector(lavPredict(cfa_cd, newdata = cj_exp_prepost))
cj_exp_prepost$conc_dis <- cd_predict


re <- lmer(car_jack_rate~t+post_floyd+post_floyd_3+conc_dis+
             age_19_29_perc+age_30_49_perc+age_50_69_perc+
             age_70_plus_perc+ post_floyd:conc_dis+post_floyd_3:conc_dis+
             (1|GEOID), 
          data = cj_exp_prepost)
summary(re)

re_logit_cd <- glmer(anyjack ~ t+post_floyd+post_floyd_3+conc_dis+
             age_19_29_perc+age_30_49_perc+age_50_69_perc+
             age_70_plus_perc+ post_floyd:conc_dis+post_floyd_3:conc_dis+
             (1|GEOID), 
                  data = cj_exp_prepost, family = binomial)
summary(re_logit_cd)

#build in police covariates
#what other covariates do we need here?
  #crude model - no post-treatment control
#businesses - crime generators
#percent single males
#percent "isolated" youth
#similar story with homicide?
#FE models


cj_exp_prepost <- cj_exp_prepost %>%
  mutate(GEOID = as.numeric(GEOID)) %>%
  left_join(homicide, by = c("GEOID", "year","week")) %>%
  mutate(anyhom = ifelse(homicide==0, 0, 1))

re_homicide <- lmer(homicide_rate~t+post_floyd+post_floyd_3+conc_dis+
             age_19_29_perc+age_30_49_perc+age_50_69_perc+
             age_70_plus_perc+ post_floyd:conc_dis+post_floyd_3:conc_dis+
             (1|GEOID), 
          data = cj_exp_prepost)
summary(re_homicide)

re_logit_cd_homicide <- glmer(anyhom ~ t+post_floyd+post_floyd_3+conc_dis+
             age_19_29_perc+age_30_49_perc+age_50_69_perc+
             age_70_plus_perc+ post_floyd:conc_dis+post_floyd_3:conc_dis+
             (1|GEOID), 
                  data = cj_exp_prepost, family = binomial)
summary(re_logit_cd)
```

```{r, message=F, results='asis'}
class(re) <- "lmerMod"
class(re_logit_cd) <- "lmerMod"

stargazer(re, re_logit_cd,
          title = "Interrupted Time Series Models of Carjackings, MPLS 2017-2022",
          covariate.labels = c("T", "Post-Killing", "Post-Killing 3 Months",
                              "Conc. Dis.", "Age 19-29", "Age 30-49", 
                              "Age 50-69", "Age 70+", 
                              "Post-Killing X Conc. Dis.",
                              "Post-Killing 3 Months X Conc. Dis."),
          header = F,
          dep.var.caption = "Carjacking",
          dep.var.labels = c("Rate per 1,000", "Any Carjacking"),
          model.names = FALSE,
          column.labels = c("RE HLM","RE Logit"),
          report = "vcs",
          ci=TRUE, 
          ci.level=0.95, 
          ci.separator = "|",
          notes = "95\\% Confidence Intervals in parentheses",
          single.row = F,
          omit.stat = c("adj.rsq", "aic", "bic"),
          #star.cutoffs = c(.05, .01, .001), star.char = c("*","**","***"),
          add.lines = list(c("SD(Tract)", .008, .650),
                           c("SD(Residual)",  .067, "")),
          notes.append = F)


```

# RE CJ Models

```{r, message=F, results='asis'}
class(re_homicide) <- "lmerMod"
class(re_logit_cd_homicide) <- "lmerMod"

stargazer(re_homicide, re_logit_cd_homicide,
          title = "Interrupted Time Series Models of Homicide, MPLS 2017-2022",
          covariate.labels = c("T", "Post-Killing", "Post-Killing 3 Months",
                              "Conc. Dis.", "Age 19-29", "Age 30-49", 
                              "Age 50-69", "Age 70+", 
                              "Post-Killing X Conc. Dis.",
                              "Post-Killing 3 Months X Conc. Dis."),
          header = F,
          dep.var.caption = "Homicide",
          dep.var.labels = c("Rate per 1,000", "Any Homicide"),
          model.names = FALSE,
          column.labels = c("RE HLM","RE Logit"),
          report = "vcs",
          ci=TRUE, 
          ci.level=0.95, 
          ci.separator = "|",
          notes = "95\\% Confidence Intervals in parentheses",
          single.row = F,
          omit.stat = c("adj.rsq", "aic", "bic"),
          #star.cutoffs = c(.05, .01, .001), star.char = c("*","**","***"),
          add.lines = list(c("SD(Tract)", .003, .031),
                           c("SD(Residual)", .065, "-")),
          notes.append = F)
```






