---
title: "Mental Health Series"
author: "Ryan Larson"
date: "12/28/2022"
output: pdf_document
header-includes:
- \usepackage{dcolumn}
- \usepackage{lscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
---

```{r setup, include=FALSE, message=F}
library(dplyr)
library(tidyr)
library(stringr)
library(readr)
library(lubridate)
library(ggplot2)
library(astsa)
library(tseries)
library(tidycensus)
library(sf)
library(purrr)
library(imputeTS)
library(rnoaa)
library(ISOweek)
library(ggmap)
library(ggrepel)
library(suncalc)
library(stargazer)
library(tidyquant)

google_key <- readRDS("C:/Users/rlarson21/Documents/R/Rworkingdirectory/google_api_key.rds")
register_google(key = google_key)
```

# Base Panel Construction - ZCTA-Week Level

## Hospital Data - ZCTA-Week level

```{r hosp data, message=FALSE}
hosp_zcta <- read_csv("Data/Restricted MHA Data/minnepop_1620_agg_zipfull_MH_102222.csv") %>%
  arrange(zipcode, year, weekofyr) %>%
  select(-c(`_chk`, zippop_tag)) %>%
  filter(!(year==2016 & weekofyr==53))
```

## ZCTAs and ACS 5-Year Estimates

```{r acs, message=FALSE, warning=FALSE}
#adding in 5-year ACS data 
census_api_key("ecda17575f4d914b502c70f2bae7a5f3d253792d")

year <- lst(2016, 2017, 2018, 2019, 2020)

acs <- map_dfr(
  year,
  ~ get_acs(geography = "zcta", 
               variables = c("B01001_001E", "B03003_003E",
                             "B02001_003E", "B02001_002E",
                             "B02001_004E", "B02001_008E",
                             "B02001_005E", "B02001_006E",
                             "B02001_007E", "B11001_003E",
                             "B17001_002E", "B01002_001E", 
                             "B09010_002E", "B06009_005E",
                             "B01001_002E", "B99233_005E",
          "B23025_005E", 
          "B19057_002E",
          "B11003_015E", 
          "B06009_002E",
          "B25003_002E", 
          "B05002_013E",
         "B19013_001E",
         "B23025_002E",
         "B07001_017E"),
               output = "wide",
               survey = "acs5",
               year = .x),  .id = "year") %>%
  rename(total_pop = B01001_001E,
         white_pop = B02001_002E,
         black_pop = B02001_003E,
         na_pop = B02001_004E,
         asian_pop = B02001_005E,
         hpi_pop = B02001_006E,
         other_pop = B02001_007E,
         biracial_pop = B02001_008E,
         hisp_pop = B03003_003E,  
         ssi_snap = B09010_002E, #snap, ssi, public cash transfers
         med_age = B01002_001E,
         mar_fam = B11001_003E,
         povlevel = B17001_002E,
         bach_degree = B06009_005E,
         male = B01001_002E,
         nowork_12 = B99233_005E,
         total_ilf = B23025_002E,
         unemp = B23025_005E, 
         pub_assist = B19057_002E,
         female_hh = B11003_015E, 
         no_hs_dip = B06009_002E,
         res_mob = B07001_017E, 
         own_hh = B25003_002E, 
         foreign = B05002_013E,
        med_hh_inc = B19013_001E) %>%
  select(-ends_with("M", ignore.case = F), -GEOID) %>%
  mutate(zcta = str_sub(NAME, 6),
          unemp_rate = 100*unemp/total_ilf, 
         pov_rate = 100*povlevel/total_pop,
         pub_assist_rate = 100*pub_assist/total_pop,
         female_hh_rate = 100*female_hh/total_pop,
         no_hs_dip_rate = 100*no_hs_dip/total_pop,
         bach_degree_rate = 100*bach_degree/total_pop,
         res_mob_rate = 100-100*res_mob/total_pop,
         own_hh_rate = 100*own_hh/total_pop,
         foreign_rate = 100*foreign/total_pop) %>%
  select(-NAME) %>%
  select(zcta, everything()) %>%
  mutate(year = as.numeric(year),
         zcta = as.numeric(zcta))  

#joining to hospital data
hosp_panel <- hosp_zcta %>%
  left_join(acs, by = c("zipcode"="zcta", "year"))

#SF geometries - get all ZCTAs 
zcta <- get_acs(geography = "zcta",
                   variables = "B01001_001",
                   output = "wide", 
                   year = 2020,
                   geometry = T,
                   survey = "acs5") %>%
  rename(zcta = GEOID,
         pop_2019 = B01001_001E) %>%
  select(-c(NAME, B01001_001M, pop_2019)) %>%
  mutate(zcta = as.numeric(zcta))


#minneapolis shapefile (source: openminneapolis.gov)
mpls <- st_read("Data/mpls_city-shp/16cdbbfa-ad10-493c-afaf-52b61f2e76e42020329-1-180h9ap.whbo.shp") %>%
   st_set_crs(st_crs(zcta))

#zctas that intersect MPLS
zcta_intersect <- zcta %>%
 st_filter(mpls, .predicate = st_intersects) %>%
  mutate(zcta_area = as.numeric(st_area(.)),
         zcta_area_sqkm = zcta_area*.000001, 
         zcta_area_sqmi = zcta_area_sqkm*.386102,
         intersection_area = as.numeric(st_area(st_intersection(., mpls))),
         perc_intersection = round(intersection_area/zcta_area*100,2)) %>%
  filter(perc_intersection >= 5)

#filter hospital panel
panel <- hosp_panel %>%
  filter(zipcode %in% zcta_intersect$zcta) %>%
  mutate(zcta = zipcode)

#creating date bookends
panel <- panel %>%
  group_by(zipcode, year) %>%
  mutate(begin_date = ISOweek2date(paste(year, paste0("W", sprintf("%02d", weekofyr)), 1,sep = "-")),
         end_date = begin_date+weeks(1)-days(1))

#number of unique MPLS ZCTAs
n_zcta <- length(unique(panel$zcta))

#vector of intersecting ZCTAs for filtering downstream
zcta_universe <- unique(panel$zcta)

```

## ZCTA-Week Level Police Data

```{r, warning=F, message=FALSE}
#Minneapolis Police Department - Use of Force Dashboard
uof_spatial <- read_csv("Data/Police_Use_Of_Force.csv")  %>%
  mutate(date=ymd_hms(ResponseDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  select(OBJECTID, year, week, X, Y, Race) %>%
  st_as_sf(coords = c("X", "Y"), crs = "NAD83", remove=F) %>%
  mutate(intersection = as.integer(st_intersects(geometry, zcta)), 
         zcta = ifelse(is.na(intersection), NA, zcta$zcta[intersection])) %>%
  st_drop_geometry() %>%
  filter(!is.na(zcta) & year >= 2016 & year <= 2021 & zcta %in% zcta_universe) %>%
  group_by(year, week, zcta, Race, .drop=F) %>%
  tally(name = "use_of_force") %>%
  filter(!is.na(Race) & Race!="not recorded") %>%
  ungroup() %>%
  complete(year, week, zcta=zcta_universe, Race, fill = list(use_of_force = 0)) %>%
  arrange(year, week, zcta, Race) %>%
  mutate(race = str_to_lower(Race)) %>%
  select(-Race) %>%
  pivot_wider(names_from = race, 
              values_from = use_of_force,
              values_fill = 0,
              names_glue = "{race}_{.value}") %>%
  mutate(total_use_of_force = asian_use_of_force+black_use_of_force+`native american_use_of_force`+
           `other / mixed race_use_of_force`+`pacific islander_use_of_force`+unknown_use_of_force+           
            white_use_of_force)

#MPD Stop Dashboard
stop_spatial <- read_csv("Data/Police_Stop_Data.csv") %>%
  mutate(date=ymd_hms(responseDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  select(OBJECTID, year, week, lat, long, race) %>%
  st_as_sf(coords = c("long", "lat"), crs = "NAD83", remove=F) %>%
  mutate(intersection = as.integer(st_intersects(geometry, zcta)), 
         zcta = ifelse(is.na(intersection), NA, zcta$zcta[intersection])) %>%
  st_drop_geometry() %>%
  filter(!is.na(zcta) & year >= 2016 & year <= 2020 & zcta %in% zcta_universe) %>%
  group_by(year, week, zcta, race, .drop=F) %>%
  tally(name = "police_stops") %>%
   filter(!is.na(race) & race!="not recorded") %>%
  ungroup() %>%
  complete(year, week, zcta=zcta_universe, race, fill = list(police_stops = 0)) %>%
  mutate(race = str_to_lower(race)) %>%
  arrange(year, week, zcta, race) %>%
  pivot_wider(names_from = race, 
              values_from = police_stops,
              values_fill = 0,
              names_glue = "{race}_{.value}") %>%
  mutate(total_police_stops = asian_police_stops+black_police_stops+
         `east african_police_stops`+latino_police_stops+`native american_police_stops`+
           other_police_stops+unknown_police_stops+white_police_stops)

#Officer Involved Shootings - MPD
ois_spatial <- read_csv("Data/Police_Officer_Involved_Shootings.csv") %>%
  mutate(date=ymd_hms(IncidentDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  select(OBJECTID, year, week, CenterLatitude, CenterLongitude, SubjectOfForceRace) %>%
  rename(race = SubjectOfForceRace,
         lat = CenterLatitude,
         long = CenterLongitude) %>%
  st_as_sf(coords = c("long", "lat"), crs = "NAD83", remove=F) %>%
  mutate(intersection = as.integer(st_intersects(geometry, zcta)), 
         zcta = ifelse(is.na(intersection), NA, zcta$zcta[intersection])) %>%
  st_drop_geometry() %>%
  filter(!is.na(zcta) & year >= 2016 & year <= 2020 & zcta %in% zcta_universe) %>%
  group_by(year, week, zcta, race, .drop=F) %>%
  tally(name = "police_shootings") %>%
  filter(!is.na(race) & race!="not recorded") %>%
  ungroup() %>%
  complete(year=2016:2021, week=1:53, zcta=zcta_universe, race, fill = list(police_shootings = 0)) %>%
  mutate(race = str_to_lower(race)) %>%
  arrange(year, week, zcta, race) %>%
  pivot_wider(names_from = race, 
              values_from = police_shootings,
              values_fill = 0,
              names_glue = "{race}_{.value}") %>%
  mutate(total_police_shootings = asian_police_shootings+black_police_shootings+
         hispanic_police_shootings+other_police_shootings+
           unknown_police_shootings+white_police_shootings)

panel <- panel %>%
  left_join(uof_spatial, by = c("year", "weekofyr"="week", "zcta"="zcta")) %>%
  left_join(stop_spatial, by = c("year", "weekofyr"="week", "zcta"="zcta")) %>%
  left_join(ois_spatial, by = c("year", "weekofyr"="week", "zcta"="zcta")) 

#creating period indicators for panel
panel <- panel %>%
  mutate(post_floyd = as.factor(as.numeric(begin_date >= as.Date("2020-05-25"))),
         post_floyd_3 = as.factor(as.numeric(begin_date >= as.Date("2020-05-25")+months(3))),
         stay_at_home = as.factor(as.numeric(begin_date >= as.Date("2020-03-28") &                                                                                     begin_date <= as.Date("2020-05-28"))),
         state_of_emerg = as.factor(as.numeric(begin_date >= as.Date("2020-03-13"))),
         weeks_post = as.numeric(begin_date-as.Date("2020-05-25"))/7,
         t_post_floyd = ifelse(weeks_post >=0,
                               weeks_post,
                               0),
         uof_rate = total_use_of_force/total_pop*1000,
         stops_rate = total_police_stops/total_pop*1000,
         ois_rate = total_police_shootings/total_pop*1000) %>%
  group_by(zcta) %>%
  arrange(year, weekofyr) %>%
  mutate(t = row_number(),
         uof_lag = dplyr::lag(uof_rate, 1),
         stops_lag = dplyr::lag(stops_rate, 1),
         shoot_lag = dplyr::lag(ois_rate, 1))
```

# Weather Data

```{r, message=F}
# Minnesota DNR Daily Date
 # https://www.dnr.state.mn.us/climate/historical/daily-data.html?sid=mspthr&sname=Minneapolis/St%20Paul%20Threaded%20Record&sdate=2010-01-01&edate=por
 # Station Name: Minneapolis/St Paul Threaded Record - Station ID: mspthr

weather <- read_csv("Data/dnr_weather.csv") %>%
  mutate(year=isoyear(Date),
         week=isoweek(Date),
         precip_in = as.numeric(ifelse(`Precipitation (inches)`=="T", .001, `Precipitation (inches)`)),
         snow_in = as.numeric(ifelse(`Snow (inches)`=="T", .001, `Snow (inches)`)),
         tmax_f = `Maximum Temperature degrees (F)`) %>%
  filter(year >= 2016 & year <= 2020) %>%
  select(year, week, precip_in, snow_in, tmax_f) %>%
  group_by(year, week) %>%
  summarize(precip_in = mean(precip_in, na.rm = T), 
            snow_in = mean(snow_in, na.rm = T), 
            tmax_f = mean(tmax_f, na.rm = T))

#join to panel
panel <- panel %>% left_join(weather, by = c("year","weekofyr"="week"))
```

# Time Series Construction - Week Level

## Aggregate Hospital Panel to Week-Level

```{r aggregation, message=FALSE}
#panel to week-level, aggregating over ZCTAs
hosp_series <- panel %>%
  group_by(year, weekofyr) %>%
  summarize(mh_all_tot = sum(mh_all_tot, na.rm = T),
            white_mh_all_tot =  sum(white_mh_all_tot, na.rm = T),
            indig_mh_all_tot =  sum(indig_mh_all_tot, na.rm = T),
            asian_mh_all_tot =  sum(asian_mh_all_tot, na.rm = T),
            black_mh_all_tot =  sum(black_mh_all_tot, na.rm = T),
            latin_mh_all_tot =  sum(latin_mh_all_tot, na.rm = T),
            total_pop = sum(total_pop, na.rm = T),
            white_pop = sum(white_pop, na.rm = T),
            na_pop = sum(na_pop, na.rm = T),
            hisp_pop = sum(hisp_pop, na.rm = T),
            asian_pop = sum(asian_pop, na.rm = T),
            black_pop = sum(black_pop, na.rm = T)) %>%
  mutate(mh_incid_c = (mh_all_tot/total_pop)*1000,
         white_mh_incid_c = (white_mh_all_tot/white_pop)*1000,
         indig_mh_incid_c = (indig_mh_all_tot/na_pop)*1000,
         asian_mh_incid_c = (asian_mh_all_tot/asian_pop)*1000,
         black_mh_incid_c = (black_mh_all_tot/black_pop)*1000,
         latin_mh_incid_c = (latin_mh_all_tot/hisp_pop)*1000) %>%
  ungroup() %>%
  mutate(week_id = row_number()) 
```

## Police Data Week-Level

```{r police data, message = FALSE, warning=FALSE}
#Minneapolis Police Department - Use of Force Dashboard
uof <- read_csv("Data/Police_Use_Of_Force.csv") %>%
  mutate(date=ymd_hms(ResponseDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  group_by(year, week, .drop=F) %>%
  tally(name = "use_of_force") %>%
  arrange(year, week) %>%
  ungroup() %>%
  select(year, week, everything())

#merge onto series
series <- hosp_series %>%
  left_join(uof, by=c("year", "weekofyr"="week")) %>%
  mutate(use_of_force_rate = (use_of_force/total_pop)*1000)

#MPD Officer Involved Shootings
ois <- read_csv("Data/Police_Officer_Involved_Shootings.csv") %>%
  mutate(date=ymd_hms(IncidentDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  group_by(year, week, .drop=F) %>%
  tally(name = "off_inv_shooting") %>%
  arrange(year, week) %>%
  ungroup() %>%
  select(year, week, everything())

#merge onto series
series <- series %>%
  left_join(ois, by=c("year", "weekofyr"="week")) %>%
  mutate(off_inv_shooting = ifelse(is.na(off_inv_shooting), 0, off_inv_shooting),
         off_inv_shooting_rate = (off_inv_shooting/total_pop)*1000)


#Minneapolis Police Department - Police Stops Dashboard
stop <- read_csv("Data/Police_Stop_Data.csv") %>%
  mutate(date=ymd_hms(responseDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  group_by(year, week, .drop=F) %>%
  tally(name = "police_stops") 

#merge onto series
series <- series %>% 
  left_join(stop, by = c("year", "weekofyr"="week")) %>%
  mutate(police_stop_rate = (police_stops/total_pop)*1000)


#creating date variable
#removing week 53 of 2020

series <- series %>%
  mutate(begin_date = ISOweek2date(paste(year, paste0("W", sprintf("%02d", weekofyr)), 1,sep = "-")),
         end_date = begin_date+weeks(1)-days(1)) %>%
  filter(!(year==2020 & weekofyr== 53)) %>%
  left_join(weather, by = c("year","weekofyr"="week"))
```

## Time Series Vizualization

```{r mh plot, warning=FALSE}
ggplot(series)+
  scale_x_date(date_labels = "%b-%Y", date_breaks = "6 months")+
   annotate(geom="rect",
    xmin = series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-03-13"))],
    xmax = series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-12-27"))],
    ymin = 0,
    ymax = 3,
    fill = "grey", 
    alpha = .4) +
  annotate(geom="rect",
    xmin = series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-03-28"))],
    xmax = series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-05-18"))],
    ymin = 0,
    ymax = 3,
    fill = "Red", 
    alpha = .1) +
  scale_fill_manual(values=c("grey","red"), labels=c("Stay at Home", "State of Emergency")) +
  geom_line(aes(x=begin_date, y=mh_incid_c))+ 
  geom_vline(xintercept=series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-05-25"))], 
              linetype="solid", color="blue", size=1) +
  geom_label(aes(x=series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-05-25"))],
                 y=3.1), 
             label = "George Floyd", show.legend = FALSE)+
  labs(title = "Figure 1: Weekly Mental Health Diagnoses, Minneapolis 2016-2020",
       subtitle = "MHA Hospital Data",
       x = "Week",
       y = "Rate per 1,000 Residents",
       fill = "MN COVID-19 Policy",
       caption = "The grey period represents the COVID-19 State of Emergency order, 
       and the red represents the COVID-19 Stay at Home order.")+
  theme_minimal()+
    theme(axis.text.x=element_text(angle=45, hjust=1)) 
```

```{r mh race plot, warning=FALSE}
ggplot(series)+
  scale_x_date(date_labels = "%b-%Y", date_breaks = "6 months")+
   annotate(geom="rect",
    xmin = series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-03-13"))],
    xmax = series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-12-27"))],
    ymin = 0,
    ymax = 2,
    fill = "grey", 
    alpha = .4) +
  annotate(geom="rect",
    xmin = series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-03-28"))],
    xmax = series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-05-18"))],
    ymin = 0,
    ymax = 2,
    fill = "Red", 
    alpha = .1) +
  scale_fill_manual(values=c("grey","red"), labels=c("Stay at Home", "State of Emergency")) +
  geom_line(aes(x=begin_date, y=white_mh_incid_c, color = "White"))+ 
  geom_line(aes(x=begin_date, y=black_mh_incid_c, color = "Black"))+
  geom_line(aes(x=begin_date, y=latin_mh_incid_c, color = "Latine"))+ 
  geom_vline(xintercept=series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-05-25"))], 
              linetype="solid", color="blue", size=1) +
  geom_label(aes(x=series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-05-25"))],
                 y=2), 
             label = "George Floyd", show.legend = FALSE)+
  labs(title = "Figure 2: Weekly Mental Health Diagnoses by Race, Minneapolis 2016-2020",
       subtitle = "MHA Hospital Data",
       x = "Week",
       y = "Rate per 1,000 Residents",
       fill = "MN COVID-19 Policy",
       color = "Race",
       caption = "The grey period represents the COVID-19 State of Emergency order, 
       and the red represents the COVID-19 Stay at Home order.")+
  theme_minimal()+
    theme(axis.text.x=element_text(angle=45, hjust=1)) +
   scale_color_manual(values = c("darkgreen", "orange", "purple"))
```

## Time Series Analysis

$y_t =\beta_0+\beta_1 Time_t + \theta Event_t + \beta_2 TimePost_t+ \mathbf{\phi X}_t+\rho_1 y_{t-1}+\rho_2 y_{t-2}+\rho_3 y_{t-3}+\epsilon_t$

```{r time series models, message=F}
series <- series %>%
  mutate(t = 1:length(mh_incid_c),
         post_floyd = as.factor(as.numeric(begin_date >= as.Date("2020-05-25"))),
         post_floyd_3 = as.factor(as.numeric(begin_date >= as.Date("2020-05-25")+months(3))),
         stay_at_home = as.factor(as.numeric(begin_date >= as.Date("2020-03-28") &                                                                                     begin_date <= as.Date("2020-05-28"))),
         state_of_emerg = as.factor(as.numeric(begin_date >= as.Date("2020-03-13"))),
         weeks_post = as.numeric(begin_date-as.Date("2020-05-25"))/7,
         t_post_floyd = ifelse(weeks_post >=0,
                               weeks_post,
                               0),
         uof_lag=lag(use_of_force_rate,1),
         stops_lag = lag(police_stop_rate,1),
         shoot_lag = lag(off_inv_shooting_rate,1)) 

mean(series$mh_incid_c[series$post_floyd==0 & series$weeks_post %in% c(-1, -2, -3, -4)])
mean(series$mh_incid_c[series$post_floyd==1 & series$weeks_post %in% c(0,1,2,3)])

mean(series$black_mh_incid_c[series$post_floyd==0 & series$weeks_post %in% c(-1, -2, -3, -4)])
mean(series$black_mh_incid_c[series$post_floyd==1 & series$weeks_post %in% c(0,1,2,3)])

mean(series$white_mh_incid_c[series$post_floyd==0 & series$weeks_post %in% c(-1, -2, -3, -4)])
mean(series$white_mh_incid_c[series$post_floyd==1 & series$weeks_post %in% c(0,1,2,3)])

mean(series$latin_mh_incid_c[series$post_floyd==0 & series$weeks_post %in% c(-1, -2, -3, -4)])
mean(series$latin_mh_incid_c[series$post_floyd==1 & series$weeks_post %in% c(0,1,2,3)])

ts <- lm(mh_incid_c~t+state_of_emerg+stay_at_home+post_floyd+t_post_floyd+
           tmax_f+snow_in+precip_in+
           uof_lag+stops_lag+shoot_lag, 
                         data = series) 
summary(ts)

acf2(resid(ts), max.lag = 7)

ts_ar3<- lm(mh_incid_c~t+post_floyd+t_post_floyd+
              state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+
                         dplyr::lag(mh_incid_c, 1)+ dplyr::lag(mh_incid_c, 2)+
               dplyr::lag(mh_incid_c, 3), 
            data = series)
summary(ts_ar3)

acf2(resid(ts_ar3), max.lag = 7)

#race specific models

ts_ar3_white <- lm(white_mh_incid_c~t+post_floyd+t_post_floyd+
                     state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+
                         dplyr::lag(white_mh_incid_c, 1)+ dplyr::lag(white_mh_incid_c, 2)+
               dplyr::lag(white_mh_incid_c, 3), 
            data = series)
summary(ts_ar3_white)

ts_ar3_black <- lm(black_mh_incid_c~t+post_floyd+t_post_floyd+
                     state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+
                         dplyr::lag(black_mh_incid_c, 1)+ dplyr::lag(black_mh_incid_c, 2)+
               dplyr::lag(black_mh_incid_c, 3), 
            data = series)
summary(ts_ar3_black)

ts_ar3_latin <- lm(latin_mh_incid_c~t+post_floyd+t_post_floyd+
                     state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+
                         dplyr::lag(latin_mh_incid_c, 1)+ dplyr::lag(latin_mh_incid_c, 2)+
               dplyr::lag(latin_mh_incid_c, 3), 
            data = series)
summary(ts_ar3_latin)

ts_ar3_indig <- lm(indig_mh_incid_c~t+post_floyd+t_post_floyd+
                     state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+
                         dplyr::lag(indig_mh_incid_c, 1)+ dplyr::lag(indig_mh_incid_c, 2)+
               dplyr::lag(indig_mh_incid_c, 3), 
            data = series)
summary(ts_ar3_indig)

ts_ar3_asian <- lm(asian_mh_incid_c~t+post_floyd+t_post_floyd+
                     state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+
                         dplyr::lag(asian_mh_incid_c, 1)+ dplyr::lag(asian_mh_incid_c, 2)+
               dplyr::lag(asian_mh_incid_c, 3), 
            data = series)
summary(ts_ar3_asian)
```

```{r, results='asis', message=FALSE, include = T}
stargazer(ts_ar3, ts_ar3_white, ts_ar3_black, ts_ar3_latin,
          title = "Interrupted Time Series Models of Mental Health Diagnoses, Minneapolis 2016-2020",
          covariate.labels = c("T",
                               "Post-Killing", "T Post-Killing",  
                               "COVID - State of Emerg.", "COVID - Stay at Home",
                               "MPD Use of Force t-1", "MPD Stops t-1",
                               "MPD OIS t-1",
                               "Mean Max. Temp.", "Snow (in.)", "Precip. (in.)",
                               "AR(1) Overall", "AR(2) Overall", "AR(3) Overall", 
                               "AR(1) White", "AR(2) White", "AR(3) White",
                               "AR(1) Black", "AR(2) Black", "AR(3) Black",
                               "AR(1) Latine", "AR(2) Latine", "AR(3) Latine"),
          dep.var.caption = "Mental Health Diagnoses/1,000",
          dep.var.labels.include = FALSE,
          column.labels = c("Overall", "White", "Black", "Latine"),
          model.numbers = TRUE,
          single.row = FALSE,
          align = T,
          omit.stat = c("adj.rsq", "f"),
          font.size="footnotesize", no.space = T, column.sep.width = "1pt",
          #star.cutoffs = c(.05, .01, .001), star.char = c("*","**","***"),
          report = "vcs",
          ci=TRUE, 
          ci.level=0.95, 
          ci.separator = "|",
          notes = "95\\% Confidence Intervals in parentheses",
          header = F,
          notes.append = F)
```

# ZCTA-Week Level Analysis

## Panel Analysis

```{r panel analysis, message=F}
panel <- panel %>%
  mutate(black_pop_center = scale(black_pop, center = T, scale = T),
         post_floyd = as.factor(post_floyd),
         stay_at_home = as.factor(stay_at_home),
         state_of_emerg = as.factor(state_of_emerg),
         mh_rate = mh_all_tot/total_pop*1000,
         blk_mh_rate = black_mh_all_tot/black_pop*1000,
         white_mh_rate = white_mh_all_tot/white_pop*1000,
         latin_mh_rate = latin_mh_all_tot/hisp_pop*1000) 

#CFA: CD
library(lavaan)

cd_model_1  <- ' cd =~ unemp_rate + pov_rate +  female_hh_rate + no_hs_dip_rate + black_pop 
                  black_pop ~~ unemp_rate'  

cfa_cd <- cfa(cd_model_1, data = panel, std.lv = T)
modificationindices(cfa_cd)
summary(cfa_cd, fit.measures=TRUE, standardized = T)
cd_predict <- as.vector(lavPredict(cfa_cd, newdata = as.data.frame(panel)))
panel$conc_dis <- cd_predict
```


$y_{ti} =\beta_{0i}+\beta_1 Time_t + \theta_i Event_t + \beta_2 TimePost_t+ \mathbf{\phi X}_{ti}+\rho_1 y_{t-1}+\rho_2 y_{t-2}+\rho_3 y_{t-3}+\epsilon_{ti}$

$\beta_{0i} = \gamma_{00}+u_{0i}$

$\theta_{i} = \gamma_{10}+u_{i}$

```{r, message=F}
#random effects specifications
library(lme4)
library(lmerTest)

#RE random coefficient model
re <- lmer(mh_rate~t+post_floyd+t_post_floyd+
                         state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+
             conc_dis+
              dplyr::lag(mh_rate, 1)+ dplyr::lag(mh_rate, 2)+
               dplyr::lag(mh_rate, 3)+
                       (post_floyd|zcta), data = panel)
summary(re)

re_blk <- lmer(blk_mh_rate~t+post_floyd+t_post_floyd+
                         state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+
             conc_dis+
              dplyr::lag(blk_mh_rate, 1)+ dplyr::lag(blk_mh_rate, 2)+
               dplyr::lag(blk_mh_rate, 3)+
                       (post_floyd|zcta), data = panel)
summary(re_blk)

re_white <- lmer(white_mh_rate~t+post_floyd+t_post_floyd+
                         state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+
             conc_dis+
              dplyr::lag(white_mh_rate, 1)+ dplyr::lag(white_mh_rate, 2)+
               dplyr::lag(white_mh_rate, 3)+
                       (post_floyd|zcta), data = panel)
summary(re_white)

re_latin <- lmer(latin_mh_rate~t+post_floyd+t_post_floyd+
                         state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+
             conc_dis+
              dplyr::lag(latin_mh_rate, 1)+ dplyr::lag(latin_mh_rate, 2)+
               dplyr::lag(latin_mh_rate, 3)+
                       (post_floyd|zcta), data = panel)
summary(re_latin)

#extract random coefficients
re_pf_white <- as.data.frame(coef(re_white)$zcta) %>%
  select(post_floyd1) %>%
  mutate(zipcode = as.numeric(rownames(.))) %>%
  rename(post_floyd1_white = post_floyd1)

re_pf_blk <- as.data.frame(coef(re_blk)$zcta) %>%
  select(post_floyd1) %>%
  mutate(zipcode = as.numeric(rownames(.))) %>%
  rename(post_floyd1_blk = post_floyd1)

re_pf_latin <- as.data.frame(coef(re_latin)$zcta) %>%
  select(post_floyd1) %>%
  mutate(zipcode = as.numeric(rownames(.))) %>%
  rename(post_floyd1_latin = post_floyd1)


#aggregate to zip-level over years
zip_level <- panel %>%
  group_by(zcta) %>%
   summarize(mh_all_tot = sum(mh_all_tot, na.rm = T),
            total_pop = sum(total_pop, na.rm = T),
            conc_dis = mean(conc_dis, na.rm = T)) %>%
  mutate(mh_incid_c = (mh_all_tot/total_pop)*1000) %>%
  ungroup() %>%
  left_join(zcta, by = "zcta")

zip_level <- zip_level %>%
  left_join(re_pf_white, by = c("zcta" = "zipcode")) %>%
  left_join(re_pf_blk, by = c("zcta" = "zipcode")) %>%
  left_join(re_pf_latin, by = c("zcta" = "zipcode"))
  



#george floyd square
gfs <- geocode("George Floyd Square, Minneapolis", output = "latlon") %>%
  st_as_sf(coords = c("lon", "lat"), crs = "NAD83", remove=F) %>%
  mutate(name = "George Floyd Square")

re_coef_map_white <- ggplot() +
  geom_sf(data = zip_level, aes(geometry = geometry, fill = post_floyd1_white), color = "lightgrey") + 
  geom_sf(data = mpls, aes(geometry = geometry), color = "black", alpha = 0)+
  geom_sf(data = gfs, aes(geometry = geometry), color = "black")+
  geom_text_repel(data = gfs, aes(x=lon, y=lat, label = name),
                 size = 2,
                fontface = "bold")+
  scale_fill_distiller(palette = "Spectral")+
  labs(title = "Figure 3: RE Coefficients-White Residents", 
       subtitle = "Rate per 1,000",
       fill = "Post-Killing Change")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank(),
  panel.grid.major = element_line(colour="transparent"), 
  plot.subtitle = element_text(face="italic"),
  strip.background = element_rect(fill = "white", 
                colour = "black"))+
  ggspatial::annotation_scale()+
  ggspatial::annotation_north_arrow(which_north = "true",
                                    location = "tr")

re_coef_map_blk <- ggplot() +
  geom_sf(data = zip_level, aes(geometry = geometry, fill = post_floyd1_blk), color = "lightgrey") + 
  geom_sf(data = mpls, aes(geometry = geometry), color = "black", alpha = 0)+
  geom_sf(data = gfs, aes(geometry = geometry), color = "black")+
  geom_text_repel(data = gfs, aes(x=lon, y=lat, label = name),
                 size = 2,
                fontface = "bold")+
  scale_fill_distiller(palette = "Spectral")+
  labs(title = "Figure 4: RE Coefficients-Black Residents", 
       subtitle = "Rate per 1,000",
       fill = "Post-Killing Change")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank(),
  panel.grid.major = element_line(colour="transparent"), 
  plot.subtitle = element_text(face="italic"),
  strip.background = element_rect(fill = "white", 
                colour = "black"))+
  ggspatial::annotation_scale()+
  ggspatial::annotation_north_arrow(which_north = "true",
                                    location = "tr")

re_coef_map_latin <- ggplot() +
  geom_sf(data = zip_level, aes(geometry = geometry, fill = post_floyd1_latin), color = "lightgrey") + 
  geom_sf(data = mpls, aes(geometry = geometry), color = "black", alpha = 0)+
  geom_sf(data = gfs, aes(geometry = geometry), color = "black")+
  geom_text_repel(data = gfs, aes(x=lon, y=lat, label = name),
                 size = 2,
                fontface = "bold")+
  scale_fill_distiller(palette = "Spectral")+
  labs(title = "Figure 5: RE Coefficients-Latine Residents", 
       subtitle = "Rate per 1,000",
       fill = "Post-Killing Change")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank(),
  panel.grid.major = element_line(colour="transparent"), 
  plot.subtitle = element_text(face="italic"),
  strip.background = element_rect(fill = "white", 
                colour = "black"))+
  ggspatial::annotation_scale()+
  ggspatial::annotation_north_arrow(which_north = "true",
                                    location = "tr")

cd_map <- ggplot() +
  geom_sf(data = zip_level, aes(geometry = geometry, fill = conc_dis), color="lightgrey") + 
  geom_sf(data = mpls, aes(geometry = geometry), color = "black", alpha = 0)+
  geom_sf(data = gfs, aes(geometry = geometry), color = "black")+
  geom_text_repel(data = gfs, aes(x=lon, y=lat, label = name),
                 size = 2,
                fontface = "bold")+
  scale_fill_distiller(palette = "Spectral")+
  labs(title = "Figure 6: Concentrated Disadvantage", 
       subtitle = "Standard Deviation Units",
       fill = "Conc. Disad.")+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank(),
  panel.grid.major = element_line(colour="transparent"), 
  plot.subtitle = element_text(face="italic"),
  strip.background = element_rect(fill = "white", 
                colour = "black"))+
  ggspatial::annotation_scale()+
  ggspatial::annotation_north_arrow(which_north = "true",
                                    location = "tr")

#RE random coefficient model - interaction
re_int <- lmer(mh_rate~t+post_floyd+t_post_floyd+
                         state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+conc_dis+
                 post_floyd:conc_dis+
              dplyr::lag(mh_rate, 1)+ dplyr::lag(mh_rate, 2)+
               dplyr::lag(mh_rate, 3)+
                       (1+post_floyd|zcta), data = panel)
summary(re_int)

re_int_blk <- lmer(blk_mh_rate~t+post_floyd+t_post_floyd+
                         state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+conc_dis+
                 post_floyd:conc_dis+
              dplyr::lag(blk_mh_rate, 1)+ dplyr::lag(blk_mh_rate, 2)+
               dplyr::lag(blk_mh_rate, 3)+
                       (1+post_floyd|zcta), data = panel)
summary(re_int_blk)

re_int_white <- lmer(white_mh_rate~t+post_floyd+t_post_floyd+
                         state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+conc_dis+
                 post_floyd:conc_dis+
              dplyr::lag(white_mh_rate, 1)+ dplyr::lag(white_mh_rate, 2)+
               dplyr::lag(white_mh_rate, 3)+
                       (1+post_floyd|zcta), data = panel)
summary(re_int_white)

re_int_latin <- lmer(latin_mh_rate~t+post_floyd+t_post_floyd+
                         state_of_emerg+stay_at_home+
                          uof_lag+stops_lag+shoot_lag+
                         tmax_f+snow_in+precip_in+conc_dis+
                 post_floyd:conc_dis+
              dplyr::lag(latin_mh_rate, 1)+ dplyr::lag(latin_mh_rate, 2)+
               dplyr::lag(latin_mh_rate, 3)+
                       (1+post_floyd|zcta), data = panel)
summary(re_int_latin)

#specifying varcov objects from model estimates
var_re_white <- VarCorr(re_white)
var_re_int_white <- VarCorr(re_int_white)
var_re_black <- VarCorr(re_blk)
var_re_int_black <- VarCorr(re_int_blk)
var_re_latin <- VarCorr(re_latin)
var_re_int_latin <- VarCorr(re_int_latin)
class(re_white) <- "lmerMod" 
class(re_blk) <- "lmerMod" 
class(re_latin) <- "lmerMod" 
class(re_int_blk) <- "lmerMod" 
class(re_int_white) <- "lmerMod" 
class(re_int_blk) <- "lmerMod" 
class(re_int_latin) <- "lmerMod" 



library(patchwork)

(re_coef_map_white+re_coef_map_blk)/(re_coef_map_latin+cd_map)
```

```{r, results='asis', message=FALSE, include = T}
stargazer(re_white, re_blk, re_latin, re_int_white, re_int_blk, re_int_latin,
          title = "Interrupted Time Series RE Models of Mental Health Diagnoses, Minneapolis 2016-2020",
          covariate.labels = c("T",
                               "Post-Killing", "T Post-Killing",  
                               "COVID - State of Emerg.", "COVID - Stay at Home", 
                               "MPD Use of Force t-1", "MPD Stops t-1",
                               "MPD OIS t-1",
                               "Mean Max. Temp.", "Snow (in.)", "Precip. (in.)",
                               "Conc. Disad.", 
                               "AR(1)-White", "AR(2)-White", "AR(3)-White",
                               "AR(1)-Black", "AR(2)-Black", "AR(3)-Black",
                               "AR(1)-Latine", "AR(2)-Latine", "AR(3)-Latine",
                               "Post-KillingXConc.Disad."),
          dep.var.caption = "Mental Health Diagnoses/1,000",
          dep.var.labels.include = FALSE,
          column.labels = c("White", "Black", "Latine",
                            "White w/ Int.","Black w/ Int.", "Latine w/ Interaction"),
          model.numbers = TRUE,
          single.row = FALSE,
          align = T,
          omit.stat = "adj.rsq",
          font.size="footnotesize", 
          no.space = T, 
          column.sep.width = "1pt",
          #star.cutoffs = c(.05, .01, .001), star.char = c("*","**","***"),
          report = "vcs",
          ci=TRUE, 
          ci.level=0.95, 
          ci.separator = "|",
          notes = "95\\% Confidence Intervals in parentheses",
          header = F,
          notes.append = F,
          add.lines = list(c("Resid. Var.", round(attr(VarCorr(re_white), "sc")^2,2),
                             round(attr(VarCorr(re_int_white), "sc")^2,2),
                             round(attr(VarCorr(re_blk), "sc")^2,2),
                             round(attr(VarCorr(re_int_blk), "sc")^2,2),
                              round(attr(VarCorr(re_latin), "sc")^2,2),
                             round(attr(VarCorr(re_int_latin), "sc")^2,2)), 
                                      c("ZCTA Var.", 
                                        round(var_re_white$zcta[1,1],2),
                                        round(var_re_int_white$zcta[1,1],2),
                                        round(var_re_black$zcta[1,1],2),
                                        round(var_re_int_black$zcta[1,1],2),
                                        round(var_re_latin$zcta[1,1],2),
                                        round(var_re_int_latin$zcta[1,1],2)),
                             c("Post-Floyd Var.", 
                                        round(var_re_white$zcta[2,2],2),
                                        round(var_re_int_white$zcta[2,2],2),
                                        round(var_re_black$zcta[2,2],2),
                                        round(var_re_int_black$zcta[2,2],2),
                                        round(var_re_latin$zcta[2,2],2),
                                        round(var_re_int_latin$zcta[2,2],2))))
```


```{r, results='asis'}
results_table<-standardizedSolution(cfa_cd) %>% 
  filter(row_number() %in% c(1:6)) %>% 
  dplyr::select(LHS=lhs, Specification=op, RHS=rhs, 'Std(Beta)'=est.std, SE=se, 
                'P-Value'=pvalue) %>%
  mutate(LHS = case_when(
    LHS=="cd"~"Conc. Dis.",
    LHS=="unemp_rate"~"Unemp. Rate"),  
         RHS = case_when(
           RHS=="unemp_rate"~"Unemp. Rate",
           RHS=="pov_rate"~"Poverty Rate",
           RHS=="female_hh_rate"~"Female-HH Rate",
           RHS=="no_hs_dip_rate"~"No HS Diploma Rate",
           RHS=="black_pop"~"Black Pop"
         ),
    Specification = case_when(
      Specification=="=~"~"FL",
      Specification=="~~"~"Cov."),
     `P-Value` = round(`P-Value`, 2)) 
    


stargazer(results_table, summary = FALSE, header = F,
           type="latex", style="aer", align = T, 
           title="CFA Measurement Model of Concentrated Disadvantage", 
           notes="$LR\\chi^2$ vs. saturated (4) = 1186, p < .05,  CFI = .926, SRMR = .049")
```
