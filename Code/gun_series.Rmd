---
title: "Gun Series"
author: "Ryan Larson"
date: "7/30/2021"
output: pdf_document
header-includes:
- \usepackage{dcolumn}
---

```{r setup, include=FALSE, message=F}
library(dplyr)
library(tidyr)
library(stringr)
library(readr)
library(lubridate)
library(ggplot2)
library(astsa)
library(tseries)
library(covdata)
library(tidycensus)
library(sf)
library(purrr)
library(imputeTS)
library(rnoaa)
library(ISOweek)
library(ggmap)
library(ggrepel)
library(suncalc)
library(stargazer)
library(tidyquant)

google_key <- readRDS("C:/Users/DELL/Documents/R/Rworkingdirectory/google_api_key.rds")
register_google(key = google_key)

#Covid timelines
  #https://docs.google.com/spreadsheets/d/1zu9qEWI8PsOI_i8nI_S29HDGHlIp2lfVMsGxpQ5tvAQ/edit#gid=973655443



#maps of racial composition and median hh income?
#RE interaction model forefront

#potential reviewers
#https://www.cceb.med.upenn.edu/bio/douglas-j-wiebe-phd
#https://www.dellchildrens.net/services-and-programs/research-clinical-trials/trauma-and-injury-research-center/meet-the-staff/

```

# Base Panel Construction - ZCTA-Week Level

## Hospital Data - ZCTA-Week level
```{r hosp data, message=FALSE}
hosp_zcta <- read_csv("Restricted Hospital Data/minnepop_1620_agg_zipfull_updated.csv") %>%
  arrange(zipcode, year, weekofyr) %>%
  select(-c(`_chk`, zippop_tag)) %>%
  filter(!(year==2016 & weekofyr==53))
```

## ZCTAs and ACS 5-Year Estimates

```{r acs, message=FALSE, warning=FALSE}
#adding in 5-year ACS data 
census_api_key("ecda17575f4d914b502c70f2bae7a5f3d253792d")

year <- lst(2016, 2017, 2018, 2019)

acs <- map_dfr(
  year,
  ~ get_acs(geography = "zcta", 
               variables = c("B01001_001E", "B03003_003E",
                             "B02001_003E", "B02001_002E",
                             "B02001_004E", "B02001_008E",
                             "B02001_005E", "B02001_006E",
                             "B02001_007E", "B11001_003E",
                             "B17001_002E", "B01002_001E", 
                             "B09010_002E", "B06009_005E",
                             "B01001_002E", "B99233_005E"),
               output = "wide",
               survey = "acs5",
               year = .x),  .id = "year") %>%
  rename(total_pop = B01001_001E,
         white_pop = B02001_002E,
         black_pop = B02001_003E,
         na_pop = B02001_004E,
         asian_pop = B02001_005E,
         hpi_pop = B02001_006E,
         other_pop = B02001_007E,
         biracial_pop = B02001_008E,
         hisp_pop = B03003_003E,  
         ssi_snap = B09010_002E, #snap, ssi, public cash transfers
         med_age = B01002_001E,
         mar_fam = B11001_003E,
         povlevel = B17001_002E,
         bach_degree = B06009_005E,
         male = B01001_002E,
         nowork_12 = B99233_005E) %>%
  select(-ends_with("M", ignore.case = F), -GEOID) %>%
  mutate(zcta = str_sub(NAME, 6)) %>%
  select(-NAME) %>%
  select(zcta, everything()) %>%
  mutate(year = as.numeric(year)) %>%
  mutate_at(vars(-zcta, -year, -total_pop, -med_age), list(~(./total_pop)*100)) 

#LOCF imputation of 2020 until 2020 ACS release (12/9/2021)
acs_2020 <- acs %>%
  complete(zcta, year = 2016:2020) %>%
  group_by(zcta) %>%
  mutate_at(vars(-zcta, -year), 
            funs(if(sum(!is.na(.))<1) {.} else{na_locf(., option = "locf")})) %>%
  filter(year==2020)

acs_imp <- acs %>% 
  rbind(acs_2020) %>%
  mutate(zcta = as.numeric(zcta))

#joining to hospital data
hosp_panel <- hosp_zcta %>%
  left_join(acs_imp, by = c("zipcode"="zcta", "year"))

#SF geometries - get all ZCTAs 
zcta <- get_acs(geography = "zcta",
                   variables = "B01001_001",
                   output = "wide", 
                   year = 2019,
                   geometry = T,
                   survey = "acs5") %>%
  rename(zcta = GEOID,
         pop_2019 = B01001_001E) %>%
  select(-c(NAME, B01001_001M, pop_2019)) %>%
  mutate(zcta = as.numeric(zcta))


#minneapolis shapefile (source: openminneapolis.gov)
mpls <- st_read("Data/mpls_city-shp/16cdbbfa-ad10-493c-afaf-52b61f2e76e42020329-1-180h9ap.whbo.shp") %>%
   st_set_crs(st_crs(zcta))

#zctas that intersect MPLS
zcta_intersect <- zcta %>%
 st_filter(mpls, .predicate = st_intersects) %>%
  mutate(zcta_area = as.numeric(st_area(.)),
         zcta_area_sqkm = zcta_area*.000001, 
         zcta_area_sqmi = zcta_area_sqkm*.386102,
         intersection_area = as.numeric(st_area(st_intersection(., mpls))),
         perc_intersection = round(intersection_area/zcta_area*100,2)) %>%
  filter(perc_intersection >= 2)

#filter hospital panel
panel <- hosp_panel %>%
  filter(zipcode %in% zcta_intersect$zcta) %>%
  mutate(zcta = zipcode)

#creating date bookends
panel <- panel %>%
  group_by(zipcode, year) %>%
  mutate(begin_date = ISOweek2date(paste(year, paste0("W", sprintf("%02d", weekofyr)), 1,sep = "-")),
         end_date = begin_date+weeks(1)-days(1))

#number of unique MPLS ZCTAs
n_zcta <- length(unique(panel$zcta))

#vector of intersecting ZCTAs for filtering downstream
zcta_universe <- unique(panel$zcta)

```

## ZCTA-Week Level Police Data

```{r, warning=F, message=FALSE}
#Minneapolis Police Department - Use of Force Dashboard
uof_spatial <- read_csv("Data/Police_Use_Of_Force.csv")  %>%
  mutate(date=ymd_hms(ResponseDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  select(OBJECTID, year, week, X, Y, Race) %>%
  st_as_sf(coords = c("X", "Y"), crs = "NAD83", remove=F) %>%
  mutate(intersection = as.integer(st_intersects(geometry, zcta)), 
         zcta = ifelse(is.na(intersection), NA, zcta$zcta[intersection])) %>%
  st_drop_geometry() %>%
  filter(!is.na(zcta) & year >= 2016 & year <= 2020 & zcta %in% zcta_universe) %>%
  group_by(year, week, zcta, Race, .drop=F) %>%
  tally(name = "use_of_force") %>%
  filter(!is.na(Race) & Race!="not recorded") %>%
  ungroup() %>%
  complete(year, week, zcta=zcta_universe, Race, fill = list(use_of_force = 0)) %>%
  arrange(year, week, zcta, Race) %>%
  mutate(race = str_to_lower(Race)) %>%
  select(-Race) %>%
  pivot_wider(names_from = race, 
              values_from = use_of_force,
              values_fill = 0,
              names_glue = "{race}_{.value}") %>%
  mutate(total_use_of_force = asian_use_of_force+black_use_of_force+`native american_use_of_force`+
           `other / mixed race_use_of_force`+`pacific islander_use_of_force`+unknown_use_of_force+           
            white_use_of_force)

#MPD Stop Dashboard
stop_spatial <- read_csv("Data/Police_Stop_Data.csv") %>%
  mutate(date=ymd_hms(responseDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  select(OBJECTID, year, week, lat, long, race) %>%
  st_as_sf(coords = c("long", "lat"), crs = "NAD83", remove=F) %>%
  mutate(intersection = as.integer(st_intersects(geometry, zcta)), 
         zcta = ifelse(is.na(intersection), NA, zcta$zcta[intersection])) %>%
  st_drop_geometry() %>%
  filter(!is.na(zcta) & year >= 2016& year <= 2020 & zcta %in% zcta_universe) %>%
  group_by(year, week, zcta, race, .drop=F) %>%
  tally(name = "police_stops") %>%
   filter(!is.na(race) & race!="not recorded") %>%
  ungroup() %>%
  complete(year, week, zcta=zcta_universe, race, fill = list(police_stops = 0)) %>%
  mutate(race = str_to_lower(race)) %>%
  arrange(year, week, zcta, race) %>%
  pivot_wider(names_from = race, 
              values_from = police_stops,
              values_fill = 0,
              names_glue = "{race}_{.value}") %>%
  mutate(total_police_stops = asian_police_stops+black_police_stops+
         `east african_police_stops`+latino_police_stops+`native american_police_stops`+
           other_police_stops+unknown_police_stops+white_police_stops)

#Officer Involved Shootings - MPD
ois_spatial <- read_csv("Data/Police_Officer_Involved_Shootings.csv") %>%
  mutate(date=ymd_hms(IncidentDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  select(OBJECTID, year, week, CenterLatitude, CenterLongitude, SubjectOfForceRace) %>%
  rename(race = SubjectOfForceRace,
         lat = CenterLatitude,
         long = CenterLongitude) %>%
  st_as_sf(coords = c("long", "lat"), crs = "NAD83", remove=F) %>%
  mutate(intersection = as.integer(st_intersects(geometry, zcta)), 
         zcta = ifelse(is.na(intersection), NA, zcta$zcta[intersection])) %>%
  st_drop_geometry() %>%
  filter(!is.na(zcta) & year >= 2016 & year <= 2020 & zcta %in% zcta_universe) %>%
  group_by(year, week, zcta, race, .drop=F) %>%
  tally(name = "police_shootings") %>%
  filter(!is.na(race) & race!="not recorded") %>%
  ungroup() %>%
  complete(year=2016:2021, week=1:53, zcta=zcta_universe, race, fill = list(police_shootings = 0)) %>%
  mutate(race = str_to_lower(race)) %>%
  arrange(year, week, zcta, race) %>%
  pivot_wider(names_from = race, 
              values_from = police_shootings,
              values_fill = 0,
              names_glue = "{race}_{.value}") %>%
  mutate(total_police_shootings = asian_police_shootings+black_police_shootings+
         hispanic_police_shootings+other_police_shootings+
           unknown_police_shootings+white_police_shootings)

panel <- panel %>%
  left_join(uof_spatial, by = c("year", "weekofyr"="week", "zcta"="zcta")) %>%
  left_join(stop_spatial, by = c("year", "weekofyr"="week", "zcta"="zcta")) %>%
  left_join(ois_spatial, by = c("year", "weekofyr"="week", "zcta"="zcta")) 

#creating period indicators for panel
panel <- panel %>%
  mutate(post_floyd = as.numeric(begin_date >= as.Date("2020-05-25")),
         post_floyd_3 = as.numeric(begin_date >= as.Date("2020-05-25")+months(3)),
         stay_at_home = as.numeric(begin_date >= as.Date("2020-03-28") &                                                                                     begin_date <= as.Date("2020-05-28")),
         state_of_emerg = as.numeric(begin_date >= as.Date("2020-03-13")),
         period = factor(case_when(
           post_floyd==0 & post_floyd_3==0 ~ "Pre-Killing",
           post_floyd>=1 & post_floyd_3==0 ~ "0-3 Months Post-Killing",
           post_floyd>=1 & post_floyd_3>=1 ~ "3+ Months Post-Killing"),
           levels = c("Pre-Killing", "0-3 Months Post-Killing", "3+ Months Post-Killing"))) %>%
  group_by(zcta) %>%
  arrange(year, weekofyr) %>%
  mutate(t = row_number(),
         uof_lag = dplyr::lag(total_use_of_force, 1),
         stops_lag = dplyr::lag(total_police_stops, 1),
         shoot_lag = dplyr::lag(total_police_shootings, 1))
```


# Time Series Construction - Week Level

## Aggregate Hospital Panel to Week-Level
```{r aggregation, message=FALSE}
#panel to week-level, aggregating over ZCTAs
hosp_series <- panel %>%
  group_by(year, weekofyr) %>%
  summarize(assault_tot = sum(assault_tot, na.rm = T),
            unintent_tot = sum(unintent_tot, na.rm = T),
            suicide_tot = sum(suicide_tot, na.rm = T),
            undeter_tot = sum(undeter_tot, na.rm = T),
            legal_tot = sum(legal_tot, na.rm = T),
            combined_tot = sum(combined_tot, na.rm = T),
            total_pop = sum(total_pop, na.rm = T)) %>%
  mutate(assault_incid_c = (assault_tot/total_pop)*1000,
         unintent_incid_c = (unintent_tot/total_pop)*1000,
         suicide_incid_c = (suicide_tot/total_pop)*1000,
         undeter_incid_c = (undeter_tot/total_pop)*1000,
         legal_incid_c = (legal_tot/total_pop)*1000,
         combined_incid_c = (combined_tot/total_pop)*1000) %>%
  ungroup() %>%
  mutate(week_id = row_number()) 
```

## Police Data Week-Level

```{r police data, message = FALSE, warning=FALSE}
#Minneapolis Police Department - Use of Force Dashboard
uof <- read_csv("Data/Police_Use_Of_Force.csv") %>%
  mutate(date=ymd_hms(ResponseDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  group_by(year, week, .drop=F) %>%
  tally(name = "use_of_force") %>%
  arrange(year, week) %>%
  ungroup() %>%
  select(year, week, everything())

#merge onto series
series <- hosp_series %>%
  left_join(uof, by=c("year", "weekofyr"="week")) %>%
  mutate(use_of_force_rate = (use_of_force/total_pop)*1000)

#MPD Officer Involved Shootings
ois <- read_csv("Data/Police_Officer_Involved_Shootings.csv") %>%
  mutate(date=ymd_hms(IncidentDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  group_by(year, week, .drop=F) %>%
  tally(name = "off_inv_shooting") %>%
  arrange(year, week) %>%
  ungroup() %>%
  select(year, week, everything())

#merge onto series
series <- series %>%
  left_join(ois, by=c("year", "weekofyr"="week")) %>%
  mutate(off_inv_shooting = ifelse(is.na(off_inv_shooting), 0, off_inv_shooting),
         off_inv_shooting_rate = (off_inv_shooting/total_pop)*1000)


#Minneapolis Police Department - Police Stops Dashboard
stop <- read_csv("Data/Police_Stop_Data.csv") %>%
  mutate(date=ymd_hms(responseDate),
         year=isoyear(date),
         week=isoweek(date)) %>%
  group_by(year, week, .drop=F) %>%
  tally(name = "police_stops") 

#merge onto series
series <- series %>% 
  left_join(stop, by = c("year", "weekofyr"="week")) %>%
  mutate(police_stop_rate = (police_stops/total_pop)*1000)


#creating date variable
series <- series %>%
  mutate(begin_date = ISOweek2date(paste(year, paste0("W", sprintf("%02d", weekofyr)), 1,sep = "-")),
         end_date = begin_date+weeks(1)-days(1))

```

# Weather Data

```{r, message=F}
# Minnesota DNR Daily Date
 # https://www.dnr.state.mn.us/climate/historical/daily-data.html?sid=mspthr&sname=Minneapolis/St%20Paul%20Threaded%20Record&sdate=2010-01-01&edate=por
 # Station Name: Minneapolis/St Paul Threaded Record - Station ID: mspthr

weather <- read_csv("Data/dnr_weather.csv") %>%
  mutate(year=isoyear(Date),
         week=isoweek(Date),
         precip_in = as.numeric(ifelse(`Precipitation (inches)`=="T", .001, `Precipitation (inches)`)),
         snow_in = as.numeric(ifelse(`Snow (inches)`=="T", .001, `Snow (inches)`)),
         tmax_f = `Maximum Temperature degrees (F)`) %>%
  filter(year >= 2016 & year <= 2020) %>%
  select(year, week, precip_in, snow_in, tmax_f) %>%
  group_by(year, week) %>%
  summarize(precip_in = mean(precip_in, na.rm = T), 
            snow_in = mean(snow_in, na.rm = T), 
            tmax_f = mean(tmax_f, na.rm = T))

#join to series
series <- series %>% left_join(weather, by = c("year","weekofyr"="week"))
```



## Sunset Data
```{r, message=FALSE}
#setting lat-lon for MPLS
mpls_lonlat <- geocode("Minneapolis, MN", output = "latlon", source="google")

#scrape sunset times for each begin date
  #mutate to UTC-6 CST 
  #calculate hours of darkness before midnight
sun_series <- getSunlightTimes(date = seq(min(series$begin_date), 
                               max(series$begin_date), 
                               "days"),
                               lat = 44.97775	,
                               lon = -93.26501,
                               keep = "sunset",
                               tz = "UTC") %>%
  mutate(sunset = sunset-hours(6),
         midnight = as.POSIXlt(date+days(1), format = '%Y-%m-%d %H:%M:%S'),
         dark = as.numeric(midnight-sunset), 
         year = year(date), 
         week = isoweek(date)) %>%
  group_by(year, week) %>%
  summarize(dark_before_12 = mean(dark, na.rm = T))


#joining to series
series <- series %>%
  left_join(sun_series, by = c("year", "weekofyr"="week"))
```

## School Data
```{r}
#created manually from online MPLS Public School Calendars: https://mpls.k12.mn.us/calendars
school <- series %>%
  select(year, weekofyr, begin_date, end_date) %>%
  mutate(days_in_week = as.numeric((end_date-begin_date))+1, 
         days_in_school = NA_integer_)

school[1,6] <- 5
school[2,6] <- 4
school[3,6] <- 3
school[4,6] <- 5
school[5,6] <- 5
school[6,6] <- 4
school[7,6] <- 4
school[8,6] <- 5
school[9,6] <- 5
school[10,6] <- 4
school[11,6] <- 4
school[12,6] <- 5
school[13,6] <- 0
school[14,6] <- 5
school[15,6] <- 5
school[16,6] <- 5
school[17,6] <- 5
school[18,6] <- 5
school[19,6] <- 5
school[20,6] <- 5
school[21,6] <- 5
school[22,6] <- 4
school[23,6] <- 2
school[24,6] <- 0
school[25,6] <- 0
school[26,6] <- 0
school[27,6] <- 0
school[28,6] <- 0
school[29,6] <- 0
school[30,6] <- 0
school[31,6] <- 0
school[32,6] <- 0
school[33,6] <- 0
school[34,6] <- 0
school[35,6] <- 5
school[36,6] <- 4
school[37,6] <- 5
school[38,6] <- 5
school[39,6] <- 5
school[40,6] <- 5
school[41,6] <- 5
school[42,6] <- 2
school[43,6] <- 5
school[44,6] <- 3
school[45,6] <- 5
school[46,6] <- 5
school[47,6] <- 2
school[48,6] <- 5
school[49,6] <- 5
school[50,6] <- 5
school[51,6] <- 0
school[52,6] <- 0
school[53,6] <- 4
school[54,6] <- 5
school[55,6] <- 4
school[56,6] <- 4
school[57,6] <- 4
school[58,6] <- 5
school[59,6] <- 4
school[60,6] <- 4
school[61,6] <- 5
school[62,6] <- 5
school[63,6] <- 5
school[64,6] <- 5
school[65,6] <- 3
school[66,6] <- 0
school[67,6] <- 5
school[68,6] <- 5
school[69,6] <- 5
school[70,6] <- 5
school[71,6] <- 5
school[72,6] <- 5
school[73,6] <- 5
school[74,6] <- 4
school[75,6] <- 5
school[76,6] <- 3
school[77,6] <- 0
school[78,6] <- 0
school[79,6] <- 0
school[80,6] <- 0
school[81,6] <- 0
school[82,6] <- 0
school[83,6] <- 0
school[84,6] <- 0
school[85,6] <- 0
school[86,6] <- 0
school[87,6] <- 5
school[88,6] <- 4
school[89,6] <- 5
school[90,6] <- 5
school[91,6] <- 5
school[92,6] <- 5
school[93,6] <- 5
school[94,6] <- 2
school[95,6] <- 5
school[96,6] <- 3
school[97,6] <- 5
school[98,6] <- 5
school[99,6] <- 2
school[100,6] <- 5
school[101,6] <- 5
school[102,6] <- 5
school[103,6] <- 5
school[104,6] <- 0
school[105,6] <- 0
school[106,6] <- 0
school[107,6] <- 5
school[108,6] <- 4
school[109,6] <- 3
school[110,6] <- 5
school[111,6] <- 5
school[112,6] <- 4
school[113,6] <- 4
school[114,6] <- 5
school[115,6] <- 5
school[116,6] <- 5
school[117,6] <- 5
school[118,6] <- 4
school[119,6] <- 0
school[120,6] <- 5
school[121,6] <- 5
school[122,6] <- 5
school[123,6] <- 5
school[124,6] <- 5
school[125,6] <- 5
school[126,6] <- 5
school[127,6] <- 4
school[128,6] <- 5
school[129,6] <- 0
school[130,6] <- 0
school[131,6] <- 0
school[132,6] <- 0
school[133,6] <- 0
school[134,6] <- 0
school[135,6] <- 0
school[136,6] <- 0
school[137,6] <- 0
school[138,6] <- 0
school[139,6] <- 0
school[140,6] <- 5
school[141,6] <- 4
school[142,6] <- 5
school[143,6] <- 5
school[144,6] <- 5
school[145,6] <- 5
school[146,6] <- 5
school[147,6] <- 2
school[148,6] <- 5
school[149,6] <- 3
school[150,6] <- 5
school[151,6] <- 5
school[152,6] <- 2
school[153,6] <- 5
school[154,6] <- 5
school[155,6] <- 5
school[156,6] <- 5
school[157,6] <- 0
school[158,6] <- 0
school[159,6] <- 5
school[160,6] <- 5
school[161,6] <- 2
school[162,6] <- 5
school[163,6] <- 5
school[164,6] <- 4
school[165,6] <- 4
school[166,6] <- 5
school[167,6] <- 5
school[168,6] <- 5
school[169,6] <- 5
school[170,6] <- 4
school[171,6] <- 0
school[172,6] <- 5
school[173,6] <- 5
school[174,6] <- 5
school[175,6] <- 5
school[176,6] <- 5
school[177,6] <- 5
school[178,6] <- 5
school[179,6] <- 4
school[180,6] <- 5
school[181,6] <- 0
school[182,6] <- 0
school[183,6] <- 0
school[184,6] <- 0
school[185,6] <- 0
school[186,6] <- 0
school[187,6] <- 0
school[188,6] <- 0
school[189,6] <- 0
school[190,6] <- 0
school[191,6] <- 0
school[192,6] <- 0
school[193,6] <- 4
school[194,6] <- 5
school[195,6] <- 5
school[196,6] <- 5
school[197,6] <- 5
school[198,6] <- 5
school[199,6] <- 2
school[200,6] <- 5
school[201,6] <- 4
school[202,6] <- 5
school[203,6] <- 5
school[204,6] <- 5
school[205,6] <- 2
school[206,6] <- 5
school[207,6] <- 5
school[208,6] <- 5
school[209,6] <- 0
school[210,6] <- 0
school[211,6] <- 5
school[212,6] <- 4
school[213,6] <- 4
school[214,6] <- 5
school[215,6] <- 5
school[216,6] <- 5
school[217,6] <- 3
school[218,6] <- 5
school[219,6] <- 5
school[220,6] <- 5
school[221,6] <- 5
school[222,6] <- 4
school[223,6] <- 0
school[224,6] <- 5
school[225,6] <- 5
school[226,6] <- 5
school[227,6] <- 5
school[228,6] <- 5
school[229,6] <- 5
school[230,6] <- 5
school[231,6] <- 4
school[232,6] <- 5
school[233,6] <- 0
school[234,6] <- 0
school[235,6] <- 0
school[236,6] <- 0
school[237,6] <- 0
school[238,6] <- 0
school[239,6] <- 0
school[240,6] <- 0
school[241,6] <- 0
school[242,6] <- 0
school[243,6] <- 0
school[244,6] <- 0
school[245,6] <- 4
school[246,6] <- 5
school[247,6] <- 5
school[248,6] <- 5
school[249,6] <- 5
school[250,6] <- 5
school[251,6] <- 3
school[252,6] <- 4
school[253,6] <- 5
school[254,6] <- 4
school[255,6] <- 5
school[256,6] <- 5
school[257,6] <- 2
school[258,6] <- 5
school[259,6] <- 5
school[260,6] <- 5
school[261,6] <- 0
school[262,6] <- 0

school <- school %>%
  mutate(school = days_in_school/days_in_week) %>%
  select(year, weekofyr, school)

series <- series %>% left_join(school, by = c("year", "weekofyr"))

```

## Time Series Vizualization

```{r firearm assaults plot, warning=FALSE}
ggplot(series)+
  geom_line(aes(x=begin_date, y=assault_incid_c))+ 
  scale_x_date(date_labels = "%b-%Y", date_breaks = "6 months")+
  geom_vline(xintercept=series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-05-25"))], 
              linetype="dotted", color="red", size=1)+
  geom_label(aes(x=series$begin_date[series$year==2020 & series$weekofyr==isoweek(date("2020-05-25"))],
                 y=0.050), 
             label = "George Floyd", show.legend = FALSE)+
  labs(title = "Figure 1: Weekly Firearm Assault Injuries, 2016-2020",
       subtitle = "MHA Hospital Data",
       x = "Week",
       y = "Rate per 1,000 Residents")+
  theme_minimal()+
    theme(axis.text.x=element_text(angle=45, hjust=1)) 
```

## Time Series Analysis

```{r time series models, message=F}

series <- series %>%
  mutate(t = 1:length(assault_incid_c),
         post_floyd = as.factor(as.numeric(begin_date >= as.Date("2020-05-25"))),
         post_floyd_3 = as.factor(as.numeric(begin_date >= as.Date("2020-05-25")+months(3))),
         stay_at_home = as.factor(as.numeric(begin_date >= as.Date("2020-03-28") &                                                                                     begin_date <= as.Date("2020-05-28"))),
         state_of_emerg = as.factor(as.numeric(begin_date >= as.Date("2020-03-13"))),
         uof_lag=lag(use_of_force_rate,1),
         stops_lag = lag(police_stop_rate,1),
         shoot_lag = lag(off_inv_shooting_rate,1))
  
ts <- lm(assault_incid_c~t+state_of_emerg+stay_at_home+post_floyd+post_floyd_3+
                         tmax_f+snow_in+precip_in+dark_before_12+school, 
                         data = series) 
summary(ts)

acf2(resid(ts), max.lag = 7)

ts_ar1<- lm(assault_incid_c~t+state_of_emerg+stay_at_home+post_floyd+post_floyd_3+
                         tmax_f+snow_in+precip_in+dark_before_12+school+
                         dplyr::lag(assault_incid_c, 1), data = series)
summary(ts_ar1)

acf2(resid(ts_ar1), max.lag = 7)

ts_pol <- lm(assault_incid_c~t+state_of_emerg+stay_at_home+post_floyd+post_floyd_3+
                         tmax_f+snow_in+precip_in+dark_before_12+school+
                         uof_lag+stops_lag+shoot_lag,
                         data = series) 
summary(ts_pol)

acf2(resid(ts_pol), max.lag = 7)

ts_ar1_pol<- lm(assault_incid_c~t+state_of_emerg+stay_at_home+post_floyd+post_floyd_3+
                         tmax_f+snow_in+precip_in+dark_before_12+school+
                  uof_lag+stops_lag+shoot_lag+
                         dplyr::lag(assault_incid_c, 1), data = series)


summary(ts_ar1_pol)

acf2(resid(ts_ar1_pol), max.lag = 7)

```

```{r, results='asis', message=FALSE, include = F}
stargazer(ts_ar1, ts_ar1_pol,
          title = "Interrupted Time Series Model of Firearm Assault Injuries",
          covariate.labels = c("T","COVID - State of Emergency", "COVID - Stay at Home",
                               "Post-Killing", "Post-Killing 3 Months",  
                               "MPD Use of Force t-1", "MPD Stops t-1",
                               "MPD Officer Involved Shootings t-1",
                               "AR(1)"),
          dep.var.caption = "Firearm Assault Injuries",
          dep.var.labels = "Rate per 1,000",
          model.numbers = TRUE,
          single.row = TRUE,
          align = T,
          omit = c("tmax_f", "snow_in", "precip_in",
                   "dark_before_12", "school"),
          omit.stat = "adj.rsq",
          star.cutoffs = c(.05, .01, .001), star.char = c("*","**","***"),
          notes.label = "Models include controls for seasonality.")


```

# ZCTA-Week Level Analysis

```{r prelim maps, message=FALSE}
#aggregate to zip-level over years
zip_level <- panel %>%
  group_by(zcta, period) %>%
  summarize(assault_tot = mean(assault_tot, na.rm = T),
            unintent_tot = mean(unintent_tot, na.rm = T),
            suicide_tot = mean(suicide_tot, na.rm = T),
            undeter_tot = mean(undeter_tot, na.rm = T),
            legal_tot = mean(legal_tot, na.rm = T),
            combined_tot = mean(combined_tot, na.rm = T),
            total_pop = mean(total_pop, na.rm = T)) %>%
  mutate(assault_incid_c = (assault_tot/total_pop)*1000,
         unintent_incid_c = (unintent_tot/total_pop)*1000,
         suicide_incid_c = (suicide_tot/total_pop)*1000,
         undeter_incid_c = (undeter_tot/total_pop)*1000,
         legal_incid_c = (legal_tot/total_pop)*1000,
         combined_incid_c = (combined_tot/total_pop)*1000) %>%
  ungroup() %>%
  left_join(zcta, by = "zcta")


#george floyd square
gfs <- geocode("George Floyd Square, Minneapolis", output = "latlon") %>%
  st_as_sf(coords = c("lon", "lat"), crs = "NAD83", remove=F) %>%
  mutate(name = "George Floyd Square")

ggplot() +
  geom_sf(data = zip_level, aes(geometry = geometry, fill = assault_incid_c)) + 
  geom_sf(data = mpls, aes(geometry = geometry), color = "black", alpha = 0)+
  geom_sf(data = gfs, aes(geometry = geometry), color = "black")+
  geom_text_repel(data = gfs, aes(x=lon, y=lat, label = name),
                  size = 2,
                 fontface = "bold",
                 nudge_x = 1, nudge_y = -1)+
  facet_wrap(~period)+
  scale_fill_distiller(palette = "Spectral")+
  labs(title = "Figure 2: Firearm Assault Injury Rates by ZCTA and Period", 
       subtitle = "MHA Hospital Discharge Data",
       fill = "Incident Rate/1,000")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank(),
  panel.grid.major = element_line(colour="transparent"), 
  plot.subtitle = element_text(face="italic"),
  strip.background = element_rect(fill = "white", 
                colour = "black"))
```

## Panel Analysis
```{r panel analysis, message=F, echo=FALSE}
#merging in seasonal indicators

season <- series %>% select(year, weekofyr, tmax_f,snow_in,precip_in,dark_before_12,school)
panel <- panel %>% left_join(season, by = c("year", "weekofyr"))


fe_model <- lm(assault_incid_c~t+state_of_emerg+stay_at_home+post_floyd+post_floyd_3+
                tmax_f+snow_in+precip_in+dark_before_12+school+
                 as.factor(zcta), data = panel)
summary(fe_model)

fe_full_model <-  lm(assault_incid_c~t+state_of_emerg+stay_at_home+post_floyd+post_floyd_3+
                       tmax_f+snow_in+precip_in+dark_before_12+school+
                         uof_lag+stops_lag+shoot_lag+
                 as.factor(zcta), data = panel)
summary(fe_full_model)
acf2(resid(fe_full_model)) #autocorrelation not an issue

fe_int_model <- lm(assault_incid_c~t+state_of_emerg+stay_at_home+post_floyd+post_floyd_3+
                     tmax_f+snow_in+precip_in+dark_before_12+school+
                     as.factor(zcta)+
                     post_floyd:as.factor(zcta)+post_floyd_3:as.factor(zcta), data = panel)
summary(fe_int_model)

#random effects specifications
library(lme4)
library(lmerTest)

panel <- panel %>%
  mutate(state_of_emerg = as.factor(state_of_emerg),
         stay_at_home = as.factor(stay_at_home),
         post_floyd = as.factor(post_floyd),
         post_floyd_3 = as.factor(post_floyd_3))

#RE base model
re_base <- lmer(assault_incid_c~t+state_of_emerg+stay_at_home+
                 post_floyd+post_floyd_3+
                tmax_f+snow_in+precip_in+dark_before_12+school+
                 uof_lag+stops_lag+shoot_lag+
                 (1|zcta), data = panel)
summary(re_base)

#interaction model
re_int <- lmer(assault_incid_c~t+state_of_emerg+stay_at_home+
                 post_floyd+post_floyd_3+
                tmax_f+snow_in+precip_in+dark_before_12+school+
                 uof_lag+stops_lag+shoot_lag+
                 black_pop+
                post_floyd:black_pop+
                 (1|zcta), data = panel)
summary(re_int)

library(sjPlot)


plot_model(re_int, 
           terms = c("post_floyd", "black_pop"),
           type = "pred", 
           ci.lvl = 0.95,
           mdrt.values = "meansd",
           title = "Figure 3: Post-Killing X Percent Black Interaction Plot",
           axis.title = c("Post-Killing","Gun Assault Rate per 1,000"))+
  theme_sjplot()+
  ggplot2::labs(colour = "Percent Black")
```


```{r, message=F, results='asis', include = F}
stargazer(fe_model, fe_full_model,
          title = "Fixed Effects Interrupted Time Series Model of Firearm Assault Injuries",
          covariate.labels = c("T","COVID - State of Emergency", "COVID - Stay at Home",
                               "Post-Killing", "Post-Killing 3 Months",
                               "MPD Use of Force t-1", "MPD Stops t-1",
                               "MPD Officer Involved Shootings t-1"),
          dep.var.caption = "Firearm Assault Injuries",
          dep.var.labels = "Rate per 1,000",
          model.numbers = TRUE,
          single.row = TRUE,
          align = T,
          omit = c("zcta", "tmax_f", "snow_in","precip_in","dark_before_12","school"),
          omit.stat = "adj.rsq",
          star.cutoffs = c(.05, .01, .001), star.char = c("*","**","***"),
          add.lines = list(c("ZCTA FE", "Yes")),
          notes.label = "Models include controls for seasonality.")


```


```{r, message=F, results='asis'}
class(re_base) <- "lmerMod"
class(re_int) <- "lmerMod"

stargazer(ts_ar1_pol, re_base, re_int,
          title = "Interrupted Time Series Models of Firearm Assault Injuries",
          covariate.labels = c("T","COVID - State of Emergency", "COVID - Stay at Home",
                               "Post-Killing", "Post-Killing 3 Months",
                               "MPD Use of Force t-1", "MPD Stops t-1",
                               "MPD Officer Involved Shootings t-1", 
                                "AR(1)",
                               "Percent Black",
                               "Post-Killing X Percent Black"),
          header = F,
          dep.var.caption = "Firearm Assault Injuries",
          dep.var.labels = "Rate per 1,000",
          model.names = FALSE,
          column.labels = c("AR(1) TSR", "RE HLM","RE HLM +Int."),
          model.numbers = TRUE,
          single.row = F,
          align = T,
          omit = c("tmax_f", "snow_in","precip_in","dark_before_12","school"),
          omit.stat = c("adj.rsq"),
          star.cutoffs = c(.05, .01, .001), star.char = c("*","**","***"),
          add.lines = list(c("SD(ZCTA)", "", .826, .642),
                           c("SD(Residual)", "", 30.010, 5.461)),
          notes.label = "Models include controls ,for seasonality.")


```

```{r, message=F}
#maps of post_floyd and post_floyd_3 coefficients by zip - colored divergently
coef <- broom::tidy(fe_int_model$coefficients) %>%
  filter(str_detect(names, "post_floyd")) %>%
  mutate(period = ifelse(str_detect(names, "post_floyd_3"), "3+ Months Post-Killing", "0-3 Months Post-Killing"),
         main_effect = ifelse(period=="3+ Months Post-Killing", round(0.3399083,2), round(-0.5604477,2)),
         zcta = as.numeric(str_sub(names, -5)),
         zcta = as.numeric(ifelse(is.na(zcta), "55401", zcta)),
         interaction_effect = ifelse(zcta=="55401", 0, round(x,2)),
         coef = main_effect+interaction_effect) %>%
  select(zcta, period, coef, main_effect, interaction_effect) %>%
  arrange(zcta, period)

#creating period rows in other spatial layers
coef_zip_level <- zip_level %>%
  filter(period!="Pre-Killing") %>%
  left_join(coef, by = c("zcta", "period"))
coef_gfs <- gfs
coef_gfs[2,] <- gfs[1,]
coef_gfs$period <- c("3+ Months Post-Killing", "0-3 Months Post-Killing")
coef_mpls <- mpls
coef_mpls[2,] <- mpls[1,]
coef_mpls$period <- c("3+ Months Post-Killing", "0-3 Months Post-Killing")


ggplot() +
  geom_sf(data = coef_zip_level, aes(geometry = geometry, fill = coef)) + 
  geom_sf(data = mpls, aes(geometry = geometry), color = "black", alpha = 0)+
  geom_sf(data = coef_gfs, aes(geometry = geometry), color = "black")+
  geom_text_repel(data = gfs, aes(x=lon, y=lat, label = name),
                  size = 2,
                 fontface = "bold",
                 nudge_x = 1, nudge_y = -1)+
  scale_fill_gradient2(trans="reverse")+
  facet_wrap(~period)+
  labs(title = "Figure 3: Treatment Effects by ZCTA", 
       fill = "Coef.")+
  theme(axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank(),
  panel.grid.major = element_line(colour="transparent"), 
  plot.subtitle = element_text(face="italic"),
  strip.background = element_rect(fill = "white", 
                colour = "black"))+
  guides(fill = guide_colorbar(reverse = TRUE))
```


# MPD Murders: Figures 4 and 5

```{r, message=FALSE, warning=FALSE}
#pre-pims
mpd_2016 <- read_csv("Data/Police_Incidents_2016.csv") 
mpd_2017 <- read_csv("Data/Police_Incidents_2017.csv") 
mpd_2018a <- read_csv("Data/Police_Incidents_2018.csv")

#pims
mpd_2018b <- read_csv("Data/Police_Incidents_2018_PIMS.csv") 
mpd_2019 <- read_csv("Data/Police_Incidents_2019.csv") 
mpd_2020 <- read_csv("Data/Police_Incidents_2020.csv") 
mpd_2021 <- read_csv("Data/Police_Incidents_2021.csv")

pre_pims_base <- mpd_2016 %>%
  rbind(mpd_2017) %>%
  rbind(mpd_2018a) %>%
  rename(reportedDate = ReportedDate,
         centerLong = Long,
         centerLat = Lat) %>%
  select(FID, centerLong, centerLat, Offense, reportedDate) %>%
  rename(OBJECTID = FID, 
         X = centerLong, 
         Y = centerLat, 
         offense = Offense)

post_pims_base <- mpd_2018b %>%
  rbind(mpd_2019) %>%
  rbind(mpd_2020) %>%
  rbind(mpd_2021) %>%
  select(OBJECTID, X, Y, offense, reportedDate)

mpd <- pre_pims_base %>%
  rbind(post_pims_base) 

mpd_series <- mpd %>%
  mutate(date=ymd_hms(reportedDate),
         year=isoyear(date),
          week=isoweek(date)) %>%
  st_as_sf(coords = c("X", "Y"), crs = "NAD83", remove=F) %>%
  mutate(intersection = as.integer(st_intersects(geometry, zcta)), 
         zcta = ifelse(is.na(intersection), NA, zcta$zcta[intersection])) %>%
  st_drop_geometry() %>%
  filter(offense=="MURDR" & zcta %in% zcta_universe) %>%
  group_by(year, week, .drop=F) %>%
  tally(name = "murder") %>%
  arrange(year, week) %>%
  filter(year <= 2021 & year >= 2016) %>%
  ungroup() %>%
  complete(year, week = 1:52, fill = list(murder = 0)) 

mpls_pops_year <- series %>%
  group_by(year) %>%
  summarize(total_pop = mean(total_pop, na.rm = T)) %>%
  add_row(year = 2021, total_pop = 603465)
  

mpd_series <- mpd_series %>%
  left_join(mpls_pops_year, by = "year") %>%
  mutate(murder_rate = (murder/total_pop)*1000,
         begin_date = ISOweek2date(paste(year, paste0("W", sprintf("%02d", week)), 1,sep = "-")),
         end_date = begin_date+weeks(1)-days(1))
  
ggplot(mpd_series)+
  geom_line(aes(x=begin_date, y=murder_rate))+ 
  scale_x_date(date_labels = "%b-%Y", date_breaks = "6 months")+
  geom_vline(xintercept=mpd_series$begin_date[mpd_series$year==2020 & mpd_series$week==isoweek(date("2020-05-25"))], 
              linetype="dotted", color="red", size=1)+
  geom_label(aes(x=mpd_series$begin_date[mpd_series$year==2020 & mpd_series$week==isoweek(date("2020-05-25"))],
                 y=0.0150), 
             label = "George Floyd", show.legend = FALSE)+
  scale_y_continuous(limits = c(0,.015))+
  labs(title = "Figure 4: Weekly Murder Rate, 2016-2021",
       subtitle = "MPD Data",
       x = "Week",
       y = "Rate per 1,000 Residents")+
  theme_minimal()+
    theme(axis.text.x=element_text(angle=45, hjust=1)) 

mpd_series <- mpd_series %>% 
  mutate(csma = forecast::ma(murder_rate, order=5,centre=TRUE),
         tsma = TTR::SMA(murder_rate, n=5))

ggplot(mpd_series)+
  geom_line(aes(x=begin_date, y=murder_rate))+ 
  scale_x_date(date_labels = "%b-%Y", date_breaks = "6 months")+
  geom_vline(xintercept=mpd_series$begin_date[mpd_series$year==2020 & mpd_series$week==isoweek(date("2020-05-25"))], 
              linetype="dotted", color="red", size=1)+
  geom_label(aes(x=mpd_series$begin_date[mpd_series$year==2020 & mpd_series$week==isoweek(date("2020-05-25"))],
                 y=0.0150), 
             label = "George Floyd", show.legend = FALSE)+
  scale_y_continuous(limits = c(0,.015))+
  labs(title = "Figure 4: Weekly Murder Rate, 2016-2021",
       subtitle = "MPD Data",
       x = "Week",
       y = "Rate per 1,000 Residents", 
       color = NULL)+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  geom_line(aes(x=begin_date, y=csma, color = "CSMA(5)"))+
  #geom_line(aes(x=begin_date, y=tsma, color = "TSMA(5)"))+
  #geom_ma(aes(x = begin_date, y = murder_rate, color = "MA4"), ma_fun = SMA, n = 4)
  scale_color_manual(values = c("blue", "green"))
```

```{r}

mpls_pops_zcta <- panel %>%
  select(zcta, year, weekofyr, total_pop) %>%
  ungroup() %>%
  complete(zcta, year = 2016:2021, weekofyr = 1:52) %>%
  arrange(zcta, year, weekofyr) %>%
  mutate(total_pop = ifelse(is.na(total_pop), na_locf(total_pop), total_pop)) %>%
  group_by(zcta) %>%
  summarize(total_pop = mean(total_pop, na.rm = T))


mpd_zip <- mpd %>%
  mutate(date=ymd_hms(reportedDate),
         year=isoyear(date),
          week=isoweek(date)) %>%
  st_as_sf(coords = c("X", "Y"), crs = "NAD83", remove=F) %>%
  mutate(intersection = as.integer(st_intersects(geometry, zcta)), 
         zcta = ifelse(is.na(intersection), NA, zcta$zcta[intersection])) %>%
  st_drop_geometry() %>%
  filter(offense=="MURDR" & zcta %in% zcta_universe) %>%
  group_by(year, week, zcta, .drop=F) %>%
  tally(name = "murder") %>%
  arrange(zcta, year, week) %>%
  ungroup() %>%
  complete(year, week=1:52, zcta=zcta_universe, fill = list(murder = 0)) %>%
  filter(year <= 2021 & year >= 2016) %>%
  mutate(begin_date = ISOweek2date(paste(year, paste0("W", sprintf("%02d", week)), 1,sep = "-")),
         end_date = begin_date+weeks(1)-days(1),
         post_floyd = as.numeric(begin_date >= as.Date("2020-05-25")),
         post_floyd_3 = as.numeric(begin_date >= as.Date("2020-05-25")+months(3)),
         period = factor(case_when(
           post_floyd==0 & post_floyd_3==0 ~ "Pre-Killing",
           post_floyd>=1 & post_floyd_3==0 ~ "0-3 Months Post-Killing",
           post_floyd>=1 & post_floyd_3>=1 ~ "3+ Months Post-Killing"),
           levels = c("Pre-Killing", "0-3 Months Post-Killing", "3+ Months Post-Killing"))) %>%
  left_join(mpls_pops_zcta, by = "zcta") %>%
  group_by(period, zcta, .drop=F) %>%
  summarize(murder = mean(murder, na.rm = T),
            total_pop = mean(total_pop, an.rm = T)) %>%
  left_join(zcta, by = "zcta") %>%
  mutate(murder_rate = (murder/total_pop)*1000)

 
ggplot() +
  geom_sf(data = mpd_zip, aes(geometry = geometry, fill = murder_rate)) + 
  geom_sf(data = mpls, aes(geometry = geometry), color = "black", alpha = 0)+
  geom_sf(data = gfs, aes(geometry = geometry), color = "black")+
  geom_text_repel(data = gfs, aes(x=lon, y=lat, label = name),
                  size = 2,
                 fontface = "bold",
                 nudge_x = 1, nudge_y = -1)+
  facet_wrap(~period)+
  scale_fill_distiller(palette = "Spectral")+
  labs(title = "Figure 5: Murder Rates by ZCTA and Period", 
       subtitle = "MPD Data",
       fill = "Murder Rate/1,000")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank(),
  panel.grid.major = element_line(colour="transparent"), 
  plot.subtitle = element_text(face="italic"),
  strip.background = element_rect(fill = "white", 
                colour = "black"))
```


